"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Base=require("../Base"),hasDoc="undefined"!=typeof document,canvas,fs=require("fs"),Image=function(a){function b(a){(0,_classCallCheck3["default"])(this,b);var c=(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).call(this)),d=c;return"string"==typeof a&&(a={src:a}),(0,_assign2["default"])(d,a),d.data||null==d.width||null==d.height||(d.data=new Array(d.width*d.height*4)),c}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"getCanvas",value:function(){if(hasDoc&&!canvas&&(canvas=document.createElement("canvas")),canvas){var a=canvas.getContext("2d");a.clearRect(0,0,canvas.width,canvas.height)}return canvas}},{key:"load",value:function(){var a=this;return new _promise2["default"](function(b,c){try{if(a.src){var d=a.getCanvas();if(d){var e=d.getContext("2d"),f=document.createElement("img");f.onload=function(){var c=f.width,g=f.height;d.width=c,d.height=g,e.drawImage(f,0,0,c,g),(0,_assign2["default"])(a,{width:c,height:g,data:e.getImageData(0,0,c,g).data}),f.onload=null,b(a)},f.src=a.src,f.complete&&f.onload()}else{var g=require("pngjs2"),h=require("fs"),i=g.PNG,j=new i({});a.png=j,j.on("parsed",function(c){(0,_assign2["default"])(a,{data:c,width:j.width,height:j.height}),j.removeAllListeners(),b(a)}),h.createReadStream(a.src).pipe(j)}}else b(a)}catch(k){c(k)}})}},{key:"save",value:function(a){a+="";var b=this,c=require("pngjs2"),d=new c.PNG({width:b.width,height:b.height});return new _promise2["default"](function(c,e){d.data=b.data;var f=fs.createWriteStream(a);f.on("close",function(){c(b)}),f.on("error",function(a){e(a)}),d.pack().pipe(f)})}}]),b}(Base);Image.prototype.isImage=!0,module.exports=Image;