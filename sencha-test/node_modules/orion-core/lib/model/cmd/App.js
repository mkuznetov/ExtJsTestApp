"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),CodeBase=require("./CodeBase"),Observable=require("../../Observable"),http=require("http"),Url=require("url"),App=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this;(0,_assign2["default"])(this,{watchTasks:{},taskCount:0,buildCount:0}),a.getBuildProfiles().forEach(function(b){b.on({scope:a,watchStarted:function(c){a._onWatchTaskStarted(c.task,b)},watchIdle:function(c){a._onWatchIdle(c.task,b)},watchBuild:function(c){a._onWatchBuild(c.task,b)},watchDone:function(c){a._onWatchTaskDone(c.task,b)}})})}},{key:"startWatch",value:function(a,b){var c,d=this,e=d.watchCount||1,f=d.getBuildProfile(b),g=f.displayName,h=d.getName()+" App Watch "+g+" ("+e+")",i=f&&f.watchStarted;return i?_promise2["default"].resolve(f.watchTask):(f.watchStarted=!0,d.watchCount=e+1,d.cmdClient=a,c=d._getDispatchConfig(f.getBuildCommand("app","watch"),h),d._runDispatch(a,c).then(function(a){return f.setWatchTask(a),a}))}},{key:"_onWatchBuild",value:function(a){var b=this;a.rebuilding||a.complete||(a.rebuilding=!0,b.buildCount++,b.record&&b.record.addCls("app-watch-building"),b.fire("appWatchBuilding"))}},{key:"_onWatchIdle",value:function(a){var b=this;a.rebuilding&&(a.rebuilding=!1,b.buildCount--),b.buildCount||(b.record&&b.record.removeCls("app-watch-building"),b.fire("appWatchIdle"))}},{key:"_onWatchTaskStarted",value:function(a){var b=this;b.taskCount+=1,1===b.taskCount&&b.record&&b.record.addCls("app-watch-running app-watch-building")}},{key:"_onWatchTaskDone",value:function(a){var b=this;b.taskCount-=1,!b.taskCount&&b.record&&b.record.removeCls("app-watch-running app-watch-building")}},{key:"stopWatch",value:function(a){var b=this,c=b.getBuildProfile(a),d=c&&c.watchTask;d&&d.stop()}},{key:"launch",value:function(a){a=this.getProfileName(a);var b=this;return new _promise2["default"](function(c,d){var e=b.getBuildProfile(a);if(e)if(e.rootUrl)c(e.rootUrl);else{if(!e.watchStarted){if(!b.cmdClient)return void d("No Cmd client configured");b.startWatch(b.cmdClient,a)}e.on({scope:b,single:!0,rootUrl:function(a){c(a.url)}})}else d('No build profile named "'+a+'"')})}},{key:"getTargetUrl",value:function(a,c){return a=this.getProfileName(a),c?c.get("launch")?(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"getTargetUrl",this).call(this):this.getGeneratedSubjectUrl(a):(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"getTargetUrl",this).call(this)}},{key:"runTestBuild",value:function(a,b,c,d){b=this.getProfileName(b);var e=this;return new _promise2["default"](function(c,f){e.runBuild(a||e.cmdClient,b,"development").then(function(a){return a.on({scope:e,complete:function(){c(a)}}),d&&a.on({scope:e,logMessage:function(a){d(a)}}),a},f)})}}],[{key:"meta",get:function(){return{prototype:{isApp:!0},mixins:[Observable]}}},{key:"configPath",get:function(){return".sencha/app/sencha.cfg"}},{key:"jsonName",get:function(){return"app.json"}},{key:"kind",get:function(){return"Application"}}]),b}(CodeBase);App.prototype.isApp=!0,module.exports=App;