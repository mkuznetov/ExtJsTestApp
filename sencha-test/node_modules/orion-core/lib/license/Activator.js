"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),nodeRSA=require("node-rsa"),Uuid=require("uuid"),Base=require("orion-core/lib/Base"),File=require("orion-core/lib/fs/File"),License=require("orion-core/lib/license/License"),Activator=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"activate",value:function(a,b){var c=this,d=a.activationCode,e=new Date,f="d";return new _promise2["default"](function(g,h){if(b=b||(d?"1y":"1m"),"string"==typeof b&&(f=/^\d+([dmy])$/.exec(b),f&&(f=f[1],b=parseInt(b,10))),f&&"number"==typeof b)if(c.ready)if(a.email)if(a.print)if(a.product&&a.product.code){"y"===f?e.setFullYear(e.getFullYear()+b):"m"===f?e.setMonth(e.getMonth()+b):e.setDate(e.getDate()+b);var i=a.product.code,j={success:!0,license:{email:a.email,id:a.id||Uuid.v4(),expiration:e.toISOString(),print:a.print,type:d?"paid":"trial",schema:1,product:{code:i,version:a.product.version,productVersion:a.product.productVersion,name:"Sencha "+i[0].toUpperCase()+i.substr(1)}}};d&&(j.license.product.activationCode=d),j.license.signature=c.sign(License.getSignData(j.license)),g(j)}else h({success:!1,error:"invalid_params",msg:"Missing product/code field"});else h({success:!1,error:"invalid_params",msg:"Missing print field"});else h({success:!1,error:"invalid_params",msg:"Missing email field"});else h({success:!1,error:"unknown_error",msg:"Private key not available"});else h({success:!1,error:"invalid_params",msg:"Invalid license term "+b})})}},{key:"load",value:function(a){var c,d,e,f=Array.isArray(a)?a:[a],g=!0,h=!1,i=void 0;try{for(var j,k=(0,_getIterator3["default"])(f);!(g=(j=k.next()).done);g=!0)if(e=j.value,c=File.get(e),c.isDirectory()&&(c=c.join(b.FILENAME)),c.isFile())try{return this.privateKey=d=nodeRSA(c.readSync()),d.setOptions({signingScheme:"sha1"}),this.ready=!0,!0}catch(l){console.log("Skipping",c.path)}}catch(m){h=!0,i=m}finally{try{!g&&k["return"]&&k["return"]()}finally{if(h)throw i}}return!1}},{key:"sign",value:function(a,b){return this.privateKey.sign(a,b||"base64")}}],[{key:"FILENAME",get:function(){return"license-private-key"}},{key:"meta",get:function(){return{prototype:{ready:!1}}}}]),b}(Base);module.exports=Activator;