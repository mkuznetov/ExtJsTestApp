"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Base=require("./Base"),events=require("events"),Observable=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this.$emitter=new events.EventEmitter;a.setMaxListeners(0)}},{key:"dtor",value:function(){this.fire({type:"destroy",sender:this}),this.$emitter.removeAllListeners(),this.$emitter=null}},{key:"fire",value:function(a){return"string"==typeof a&&(a={type:a}),a.sender||(a.sender=this),this.$emitter.emit(a.type,a),a}},{key:"getListenerCount",value:function(a){return this.$emitter.listenerCount(a)}},{key:"on",value:function(a,b,c){var d=a,e=this.$emitter;if("string"==typeof a){if(!c)return e.on(a,b),null;d={scope:c},d[a]=b}return new Listener(this,d)}},{key:"un",value:function(a,b){this.$emitter.removeListener(a,b)}}],[{key:"meta",get:function(){return{prototype:{isObservable:!0}}}}]),b}(Base),listenerOptions={scope:1,delay:1,buffer:1,managed:1,single:1},Listener=function(){function a(b,c){(0,_classCallCheck3["default"])(this,a),this.owner=b,this.options=c,this.listenFns={},this.process("doAdd")}return(0,_createClass3["default"])(a,[{key:"destroy",value:function(){this.process("doRemove");var a,b,c=this.managed;if(c){for(b=c.length;b-- >0;)a=c[b],a.instance.un("destroy",a.fn);c.length=0}}},{key:"process",value:function(a){var b,c,d,e=this,f=e.options;for(b in f)b in listenerOptions||(c=f[b],d="object"===("undefined"==typeof c?"undefined":(0,_typeof3["default"])(c))?c:null,d&&(c=d.fn),e[a](b,c,f,d))}},{key:"doAdd",value:function(a,b,c,d){var e=this,f=c.buffer,g=c.delay,h=c.managed,i=c.scope,j=c.single,k=b;if(d&&(f="buffer"in d?d.buffer:f,g="delay"in d?d.delay:g,h="managed"in d?d.managed:h,i="scope"in d?d.scope:i,j="single"in d?d.single:j),i){if("string"==typeof k&&"function"!=typeof(k=i[k]))throw new Error("No such method "+b);k=k.bind(i),h!==!1&&i.on&&e.manage(i,a)}null!=g?k=e.wrapDelay(k,g):null!=f&&(k=e.wrapBuffer(k,f)),j&&(k=e.wrapSingle(a,k)),e.listenFns[a]=k,e.owner.on(a,k)}},{key:"doRemove",value:function(a){var b=this,c=b.listenFns,d=c[a];d&&(c[a]=null,b.owner.un(a,d))}},{key:"manage",value:function(a,b){var c,d,e=this,f=e.managed||(e.managed=[]);for(d=f.length;d-- >0;)if(f[d].instance===a){c=f[d];break}c||(f.push(c={instance:a,events:{}}),a.on("destroy",c.fn=e.onManagedDestroy.bind(e,c))),c.events[b]=!0}},{key:"onManagedDestroy",value:function(a){a.instance.un("destroy",a.fn);var b,c=this.managed,d=c.indexOf(a);d>=0&&c.splice(d,1);for(b in a.events)this.doRemove(b)}},{key:"wrapBuffer",value:function(a,b){var c,d,e=function(){var b=c;c=null,b?1===b.length?a(b[0]):a.apply(null,b):a()};return function(){c=arguments.length?Array.prototype.slice.call(arguments):null,d&&clearTimeout(d),d=setTimeout(e,b)}}},{key:"wrapDelay",value:function(a,b){return function(){var c=arguments;c=c.length?Array.prototype.slice.call(c):null,setTimeout(function(){c?1===c.length?a(c[0]):a.apply(null,c):a()},b)}}},{key:"wrapSingle",value:function(a,b){var c=this;return function(){return c.doRemove(a),b.apply(null,arguments)}}}]),a}();module.exports=Observable;