"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Base=require("../Base"),urlParse=require("url").parse,os=require("os"),Buffer=require("buffer").Buffer,Cookies=require("cookies"),UserAgent=require("orion-core/lib/model/UserAgent.js"),Util=require("orion-core/lib/Util"),Responder=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this,b=a.routes;a.readRequestBody!==!1&&(a.readRequestBody=!0),a.cacheBust!==!1&&(a.cacheBust=!0),a.routes={},b&&a.register(b),a.init&&a.init()}},{key:"_getPathParts",value:function(a){return a.startsWith("/")&&(a=a.substring(1)),a.split("/")}},{key:"handleRequest",value:function(a,b){var c=this,d=urlParse(a.url,!0),e=c._getPathParts(d.pathname),f=a.method.toLowerCase(),g={request:a,response:b,url:d,method:f,path:e,code:200,headers:{}};a.responderContext=g,b.responderContext=g,c.dispatch(g)}},{key:"dispatch",value:function(a){function b(b){g=(b.stack||b).toString(),a.code=500,a.headers["Content-Type"]="text/plain",console.error(g)}function c(c){try{null!=c&&"string"!=typeof c?(g=(0,_stringify2["default"])(c),a.headers["Content-Type"]="application/json"):c&&(g=c)}catch(d){b(d)}finally{f=a.response,g&&(a.headers["content-length"]=Buffer.byteLength(g).toString()),f.writeHead(a.code||f.statusCode||200,a.headers),g?f.write(g,function(){f.end()}):f.end()}}function d(){if(h=i[l]||i.get,h&&(e=h.call(i,a),!a.done))if(e)if("function"==typeof e)try{c(e())}catch(d){b(d),c()}else"function"==typeof e.then?e.then(function(a){c(a)})["catch"](function(a){b(a),c()}):c(e);else c()}var e,f,g,h,i=this,j=a.path,k=a.request,l=k.method;if(j.length){var m=j.shift(),n=i.getSubResponder(m);if(n)return n.dispatch(a);j.unshift(m)}if(i.cacheBust&&(0,_assign2["default"])(a.headers,{"cache-control":"no-cache, no-store, must-revalidate",pragma:"no-cache",expires:"-1"}),i.readRequestBody){var o="",p=a.request;p.on("data",function(a){o+=a.toString()}),p.on("end",function(){a.content=o,d()})}else d()}},{key:"getSubResponder",value:function(a){var b,c=this;if(null!=a){if(c[a]&&c[a].isResponder)return c[a];if(c.routes[a])return b=c.routes[a],b.isResponder?b:b.call(this)}}},{key:"register",value:function(a,c){var d,e,f,g,h=this;if("object"!=("undefined"==typeof a?"undefined":(0,_typeof3["default"])(a))){for(d=h._getPathParts(a),e=h;d.length>2&&(g=d.shift());){if(f=e.getSubResponder(g),!f){d.unshift(g);break}e=f}for(c&&(c.isResponder||(c=new b(c)));d.length>2;){g=d.pop();var i=c,j={routes:{}};j.routes[g]=i,c=new b(j)}var k=e.routes[d[0]];k&&(k.register(c.routes),c.routes=k.routes),e.routes[d[0]]=c}else for(var l in a)h.register(l,a[l])}},{key:"getRequestAddress",value:function(a){var b=a.connection.remoteAddress;return b.startsWith("::ffff:")&&(b=b.substr(7)),b}},{key:"isLocalRequest",value:function(a){return UserAgent.fromRequest(a).local}},{key:"getCookies",value:function(a){return new Cookies(a.request,a.response)}}]),b}(Base);Responder.prototype.isResponder=!0,module.exports=Responder;