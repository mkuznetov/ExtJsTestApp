"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),detecter=require("browser-launcher2/lib/detect"),LocalBrowser=require("orion-core/lib/model/browser/Local"),LocalEdge=require("orion-core/lib/model/browser/LocalEdge"),LocalBrowser=require("orion-core/lib/model/browser/Local"),Observable=require("orion-core/lib/Observable"),Pool=require("orion-core/lib/model/farm/Pool"),instance,LocalPool=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){this.id=Pool.nextId(),this.name="Local Browsers",this.browsers=[],this.agentGroups=[],this.data={name:this.name}}},{key:"getName",value:function(){return this.name}},{key:"add",value:function(a){var b=this,c=!1,d=b.browsers;return a.isBrowser||(a=new LocalBrowser(a)),a.manager=b,new _promise2["default"](function(e,f){d.forEach(function(b){var d=["command","description","name","type","profile","version"],e=!0;c||(d.forEach(function(c){e=e&&b.data[c]===a.data[c]}),c=e)}),c||(b.browsers.push(a),a.pool=b,a.detected||b._cacheUserBrowsers()),e(a)})}},{key:"remove",value:function(a){var b=this.browsers,c=b.indexOf(a);c!==-1&&b.splice(c,1),a.pool=null,a.detected||this._cacheUserBrowsers()}},{key:"update",value:function(a,b){(0,_assign2["default"])(a,b),this._cacheUserBrowsers()}},{key:"getBrowsers",value:function(){var a,b=this,c=b.browsers;return new _promise2["default"](function(d,e){b._browsersInited?d(c):b.detect().then(function(){var e=b._getLocalStorage();e&&(a=JSON.parse(e.getItem("orionUserLocalBrowsers")),a&&a.forEach(function(a){b.add(new LocalBrowser(a))})),b._browsersInited=!0,d(c)})})}},{key:"lookupBrowserByUserAgent",value:function(a){return this.browsers.find(function(b){return b.matchesUserAgent(a)})}},{key:"detect",value:function(){var a=this,b=new LocalEdge;return b.version&&a.add(b),new _promise2["default"](function(b,c){detecter(function(c){var d;c.forEach(function(b){"ie"===b.type.toLowerCase()&&b.command.indexOf("Program Files (x86)")>-1||b.type.indexOf("phantom")>=0||(d=new LocalBrowser({name:b.name,type:b.type,version:b.version,command:b.command,profile:"",detected:!0}),d.detected=!0,a.add(d))}),b(a)})})}},{key:"_cacheUserBrowsers",value:function(){var a,b=this,c=b._getLocalStorage();c&&(a=[],b.browsers.forEach(function(b){var c=b.data;c.detected||a.push({description:c.description,name:c.name||c.browserName,version:c.version,command:c.command,profile:c.profile,type:c.type})}),c.setItem("orionUserLocalBrowsers",(0,_stringify2["default"])(a)))}},{key:"_getLocalStorage",value:function(){return"undefined"!=typeof window?window.localStorage:null}},{key:"save",value:function(){this._cacheUserBrowsers()}},{key:"sync",value:function(a){}},{key:"browserClass",get:function(){return LocalBrowser}}],[{key:"instance",get:function(){return instance||(instance=new b)}}]),b}(Observable);LocalPool.prototype.isLocalPool=!0,module.exports=LocalPool;