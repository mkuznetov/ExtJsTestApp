"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Entity=require("./Entity"),App=require("./cmd/App"),Framework=require("./cmd/Framework"),Package=require("./cmd/Package"),Project=require("./test/Project"),Testable=require("./Testable"),Browser=require("orion-core/lib/model/browser/Browser"),GenericBrowser=require("orion-core/lib/model/browser/Generic"),EmbeddedBrowser=require("orion-core/lib/model/browser/Embedded"),LocalPool=require("orion-core/lib/browser/LocalPool"),Farm=require("orion-core/lib/model/farm/Farm"),Pool=require("orion-core/lib/model/farm/Pool"),BrowserPool=require("orion-core/lib/model/farm/Pool"),SauceLabs=require("orion-core/lib/model/farm/SauceLabs"),BrowserStack=require("orion-core/lib/model/farm/BrowserStack"),Embedded=require("orion-core/lib/model/farm/Embedded"),Json=require("orion-core/lib/Json"),Configuration=require("../config/Configuration"),xfs=require("orion-core/lib/xfs"),File=require("orion-core/lib/fs/File"),Util=require("orion-core/lib/Util"),WorkspaceScanner=require("orion-core/lib/model/WorkspaceScanner"),fs=require("fs"),path=require("path"),farmTypeMap={saucelabs:SauceLabs,browserstack:BrowserStack,generic:Farm},Workspace=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this;a.apps=[],a.packages=[],a.frameworks=[],a.farms=[],a.pathMap={}}},{key:"add",value:function(a){var b,c=this;if(a instanceof App)b=c.apps;else if(a instanceof Framework)b=c.frameworks;else if(a instanceof Package)b=c.packages;else if(a instanceof Farm)b=c.farms;else if(!(a instanceof Project))throw new Error("Unrecognized item type");b&&b.push(a),a.dir&&(c.pathMap[xfs.normalize(a.dir)]=a),a.workspace=c}},{key:"eachApp",value:function(a,b){return this._each(this.apps,a,b)}},{key:"eachFramework",value:function(a,b){return this._each(this.frameworks,a,b)}},{key:"eachPackage",value:function(a,b){return this._each(this.packages,a,b)}},{key:"eachFarm",value:function(a,b){return this._each(this.farms,a,b)}},{key:"fromPath",value:function(){var a=this.resolve.apply(this,arguments);return a=xfs.normalize(a),this.pathMap[a]||null}},{key:"fromDeepPath",value:function(){var a=this,b=a.resolve.apply(a,arguments),c=xfs.normalize(b),d=a.pathMap,e=!0,f=!1,g=void 0;try{for(var h,i=(0,_getIterator3["default"])((0,_keys2["default"])(d));!(e=(h=i.next()).done);e=!0){var j=h.value;if(0===c.indexOf(j)){var k=d[j];return k}}}catch(l){f=!0,g=l}finally{try{!e&&i["return"]&&i["return"]()}finally{if(f)throw g}}return null}},{key:"getTestScenario",value:function(a){var b=this,c=[];c=c.concat(b.apps),c=c.concat(b.packages),b.tests&&c.push(b);var d=!0,e=!1,f=void 0;try{for(var g,h=(0,_getIterator3["default"])(c);!(d=(g=h.next()).done);d=!0){var i=g.value;if(i.tests){var j=!0,k=!1,l=void 0;try{for(var m,n=(0,_getIterator3["default"])(i.tests.scenarios);!(j=(m=n.next()).done);j=!0){var o=m.value,p=File.get(o.resolve());if(p.equals(a)||p.contains(a))return o}}catch(q){k=!0,l=q}finally{try{!j&&n["return"]&&n["return"]()}finally{if(k)throw l}}}}}catch(q){e=!0,f=q}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return null}},{key:"getBrowserFarm",value:function(a){var b,c,d=this.farms;for(a=a.toLowerCase(),c=0;c<d.length;++c)if(a===(b=d[c]).getName().toLowerCase())return b;return null}},{key:"removeFarm",value:function(a){var b=this.farms,c=this.getBrowserFarm(a),d=c?b.indexOf(c):-1;d>-1&&b.splice(d,1)}},{key:"isSoloApp",value:function(){if(1===this.apps.length){var a=this.apps[0];return this.dir===a.dir}return!1}},{key:"getTestProjectPath",value:function(){var a=this.get("tests");return a=a&&a.path,a=a&&this.resolve(a)}},{key:"setSourceFile",value:function(a){(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"setSourceFile",this).call(this,a);var c,d=this.data;a&&!d.name&&(c=new File(this.dir).name,d.name=c.charAt(0).toUpperCase()+c.substring(1))}},{key:"setTestProjectPath",value:function(a){var b=this.get("tests");b||this.set("tests",b={}),b.path=a}},{key:"setCmdClient",value:function(a){this.cmdClient=a}},{key:"resolveVariables",value:function(a){return a.split("${workspace.dir}").join(this.dir)}},{key:"update",value:function(a){this.setCmdClient(a),this.loadCmdWorkspace()}},{key:"loadChildren",value:function(){var a=this;return _promise2["default"].all([a._loadTests(),a._loadApps(),a._loadFrameworks(),a._loadPackages(),a._loadBrowserPools()]).then(function(){return a})}},{key:"loadCmdWorkspace",value:function(){var a=this,b=a.cmdClient,c={application:"app.dir","package":"package.dir",frameworkpackage:"framework.dir"};b&&b.loadWorkspace(a.path).then(function(d){a.cmdConfigs=d.configs,d.children.forEach(function(d){var e=d.config,d=c[d.type];d&&(d=a.fromPath(e[d]),d&&(d.cmdConfig=e,d.cmdClient=b))})})}},{key:"createFarm",value:function(a){var b=this,c=a.type,d=farmTypeMap[c]||Farm,e=new d(a);return c&&!farmTypeMap[c]&&(e.error=new Error('Unknown browser farm type "'+c+'"')),e.workspace=b,b.add(e),e}},{key:"_each",value:function(a,b,c){if(a)for(var d=0;d<a.length&&b.call(c,a[d])!==!1;++d);}},{key:"_loadTests",value:function(){var a=this;return a.loadTests().then(function(b){return b&&a.add(b),b})}},{key:"_loadApps",value:function(){var a=this,b=a.data.apps,c=[];if(b)b.forEach(function(b){b.path&&(b=b.path),c.push(App.load(a.resolve(b),a).then(function(c){return a.add(c),c.setRelativePath(b),c}))});else if(xfs.existsSync(xfs.join(a.dir,"app.json")))return App.load(a.dir,a).then(function(b){return a.add(b),b.setRelativePath(""),b});return _promise2["default"].all(c).then(function(b){return a.apps.sort(function(a,b){var c=a.getName().toLowerCase(),d=b.getName().toLowerCase();return c<d?-1:d<c?1:0}),b})}},{key:"_loadFrameworks",value:function(){var a,b=this,c=new Configuration,d=b.dir+"/.sencha/workspace/sencha.cfg",e=[];return c.loadSync(d),a=c.get("ext.dir"),a&&e.push(Framework.load(b.resolve(a),b).then(function(a){b.add(a)})),a=c.get("touch.dir"),a&&e.push(Framework.load(b.resolve(a),b).then(function(a){b.add(a)})),_promise2["default"].all(e)}},{key:"_loadPackages",value:function(){var a=this,b=a.data.packages;return b=b&&b.dir||"packages",Package.loadAll(b,a).then(function(b){b.forEach(a.add,a)})}},{key:"_loadBrowserPools",value:function(){var a,b,c=this,d=c.data.tests,e=[];if(e.push(c._createEmbeddedFarm()),d&&d.browser)if(a=d.browser.farms,b=Array.isArray(a),Array.isArray(a))a.forEach(function(a){var b=c.createFarm(a);b.eachPool(function(a){e.push(a.loadConfigFile())})});else if(a)throw new Error('Invalid workspace.json file: "tests.browser.farms" must be an array');return _promise2["default"].all(e)}},{key:"getPersistData",value:function(){var a=(0,_assign2["default"])({},(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"getPersistData",this).call(this)),c=a.tests&&a.tests.browser;return c&&c.farms&&(c.farms=c.farms.filter(function(a){return"embedded"!==a.type})),a}},{key:"_createEmbeddedFarm",value:function(){var a=this,b=new Embedded,c=new Pool({name:"Embedded"});return b.workspace=a,a.add(b),a._embeddedFarm=b,c.isEmbeddedPool=!0,b.add(c),new _promise2["default"](function(d,e){var f=new LocalPool,g={description:"Google Chrome",profile:"",type:"chrome",name:"Chrome",detected:!1};f.detect().then(function(){f.browsers.forEach(function(a){"chrome"===a.canonicalName&&(0,_assign2["default"])(g,{version:a.data.version,detected:!0})});var e=a._getLocalPlatform(),h=new GenericBrowser(g),i=new GenericBrowser({description:h.description,browserName:h.get("type"),platform:e,detected:h.get("detected"),version:h.displayVersion,sencha:{concurrency:1,isEmbeddedBrowser:!0}});i.isEmbeddedBrowser=!0,c.add(i),b.set("sessionLimit",1),d()})})}},{key:"_getLocalPlatform",value:function(){return Util.isWindows?"WINDOWS":Util.isLinux?"LINUX":Util.isMac?"MAC":void 0}},{key:"embeddedFarm",get:function(){return this._embeddedFarm}}],[{key:"find",value:function(a){return new _promise2["default"](function(c,d){function e(f){var g,h=f.join(b.jsonName),i=f.join(b.configName);if(h.existsSync())c(h);else if(i.existsSync()){var j=new WorkspaceScanner;j.scan(f).then(function(a){h.writeJson(a,{prettyPrint:!0}).then(function(){c(h)},d)},d)}else g=f.parent,g?e(g):d(xfs.wrapError(a,a+" is not a valid workspace"))}var f=new File(a),g=f;return f.existsSync()?void e(g):void d(xfs.wrapError(a,a+" does not exist"))})}},{key:"meta",get:function(){return{prototype:{isWorkspace:!0},mixins:[Testable]}}},{key:"jsonName",get:function(){return"workspace.json"}},{key:"configName",get:function(){return".sencha/workspace/sencha.cfg"}},{key:"kind",get:function(){return"Workspace"}}]),b}(Entity);module.exports=Workspace;