"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),bodyParser=require("body-parser"),co=require("co"),compress=require("compression"),express=require("express"),fs=require("fs"),multer=require("multer"),path=require("path"),recursive=require("recursive-readdir"),Url=require("url"),uuid=require("uuid"),Base=require("orion-core/lib/Base"),console=require("orion-core/lib/util/console-manager").console,File=require("orion-core/lib/fs/File"),Merger=require("orion-core/lib/archive/Merger"),xfs=require("orion-core/lib/xfs"),Zip=require("orion-core/lib/fs/Zip"),serverDir=process.cwd(),storageRoot=xfs.join(serverDir,"storage"),PORT=1903,Catalog=function(){function a(b){(0,_classCallCheck3["default"])(this,a),this.file=b.$isFile?b:new File(b),this.path=this.file.getPath(),this.file.existsSync()?this.data=this.file.readJsonSync():this.data={}}return(0,_createClass3["default"])(a,[{key:"save",value:function(){var a=this,b=a.file,c=new File(b.parent,uuid.v1());return c.writeJson(this.data,{prettyPrint:!0}).then(function(){return xfs.rename(c.path,b.path)})}}],[{key:"getCatalog",value:function(b){var c=a.map||(a.map={}),d=b.$isFile?b.getPath():b,e=c[d];return e||(e=new a(b),c[d]=e),e}}]),a}(),ServerCommand=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"execute",value:function(){var a=this,b=this.app=express();a._operationQueue=_promise2["default"].resolve(),a.storageRoot&&(serverDir=new File(a.storageRoot).getCanonicalFile().getParent(),storageRoot=xfs.join(serverDir,"storage")),a._getStorage(),a._initCatalogs();var c=a._getDiskStorage(),d=a._getMulter(c);b.post("/upload",d,a._queueUpload.bind(a)),b.post("/download",bodyParser.json(),a._queueDownload.bind(a)),b.post("/update-baseline",bodyParser.json(),a._queueUpdateBaseline.bind(a));var e=864e5;b.use(express["static"](storageRoot,{maxAge:e})),b.use(compress()),a.port=a.port||PORT,b.listen(a.port,function(){console.log("Archive server listening on port %d",a.port)}).on("error",function(b){"EADDRINUSE"===b.code?console.log("The archive server is already actively running on port %d. Please use -p parameter to specify a different port.",a.port):console.log("There was a problem starting the archive server: %s",b.message)})}},{key:"_getDiskStorage",value:function(){var a=this;return multer.diskStorage({destination:function b(c,d,e){var f=a._getStorage(),g=c.body.storageKey,h=c.body.archivePath,b=xfs.join(storageRoot,f[g].path);h&&(b=xfs.join(b,h)),xfs.mkdir(b).then(function(){c.storageDir=new File(b),e(null,b)})},filename:function(a,b,c){var d=uuid.v1();a.stagingKey=d,c(null,d+".zip")}})}},{key:"_getMulter",value:function(a){var b=this;return multer({storage:a,fileFilter:function(a,c,d){var e,f,g=b._getStorage(),h=a.body.storageKey;return g[h]?(e=c.originalname,e.toLowerCase().endsWith(".zip")?(f=a.buildNumber=path.basename(c.originalname,".zip"),void d(null,!0)):void d("Invalid archive file name: "+e)):void d("Invalid storage key: "+h,!1)}}).single("archive")}},{key:"_queueOperation",value:function(a){return this._operationQueue=this._operationQueue.then(a)}},{key:"_queueUpload",value:function(a,b,c){var d=this;return d._queueOperation(function(){return co(d._upload(a,b,c))["catch"](function(a){console.error("Error receiving archive".red.bold),console.error(a.stack||a),b.status(500).send("Error processing archive - see server log for more information")})})}},{key:"_upload",value:_regenerator2["default"].mark(function c(a,b,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa;return _regenerator2["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return e=this,f=a.file,g=a.buildNumber,h=a.storageDir,i=a.stagingKey,j=h.join(i),k=h.join(g),l=h.join(g+".zip"),m=h.join("baseline"),n=m+".zip",o=new File(a.file.path),p=a.body.storageKey,q="true"===a.body.overwrite,r=e._getStorage(),s=r[p],t=s&&s.path,u=s&&s.allowOverwrite,v=!1,console.log("[%s] Receiving archive",g),q&&!u&&console.log("[%s] WARNING: Result overwrite not allowed in storage area %s",g,t),t.startsWith("/")&&(t=t.substring(1)),x=new File(storageRoot).join(t),y=x.join("catalog.json"),z=Catalog.getCatalog(y),A=z.data,B=a.body.archivePath,C=A.archives||(A.archives={}),C[B]=C[B]||{path:File.slashify(File.join(B,"catalog.json"))},c.next=9,z.save();case 9:if(D=Catalog.getCatalog(x.join(B).join("catalog.json")),F=D.data,F.count=F.count||0,E=F.runs||(F.runs={}),!E[g]){c.next=38;break}return console.log("[%s] Existing build found",g),console.log("[%s] Extracting %s to %s",g,o.path,j.path),c.next=18,Zip.extract(o.path,j.path);case 18:return H=new Merger({overwrite:q&&u}),I=j.join(g),console.log("[%s] Merging results",g),c.next=22,H.merge(k,I);case 22:return console.log("[%s] Results merged",g),w=H.warnings,console.log("[%s] Cleaning up temporary files",g),c.next=27,j.remove();case 27:return c.next=29,o.remove();case 29:return console.log("[%s] Compressing results",g),c.next=32,Zip.fromDir(k.path,h.join(g+"_new.zip").path,null,g);case 32:return J=c.sent,console.log("[%s] Updating result archive",g),c.next=36,xfs.rename(J.fileName,l.path);case 36:c.next=44;break;case 38:return console.log("[%s] Extracting %s to %s",g,o.path,k.path),c.next=41,Zip.extract(o.path,h.path);case 41:return console.log("[%s] Moving %s to %s",g,o.path,l.path),c.next=44,xfs.rename(o.path,l.path);case 44:return console.log("[%s] Updating catalogs",g),K=(new Date).getTime(),G=E[g]||{id:++F.count,path:g+".zip"},G.uploaded=G.uploaded||K,G.lastUpdated=K,E[g]=G,c.next=52,D.save();case 52:return console.log("[%s] Processing screenshots",g),c.next=55,function(a){recursive(k.path,["!*.png","*-baseline.png","*-diff.png"],a)};case 55:L=c.sent,M=L.length,N=0,L.length?console.log("[%s] Found %d screenshots",g,L.length):console.log("[%s] No screenshots found",g),O=!0,P=!1,Q=void 0,c.prev=61,R=(0,_getIterator3["default"])(L);case 63:if(O=(S=R.next()).done){c.next=88;break}return f=S.value,T=m.join(k.relativeTo(f)),c.next=68,xfs.exists(T);case 68:if(U=c.sent){c.next=85;break}return c.prev=70,c.next=73,xfs.mkdir(path.dirname(T.path));case 73:return c.next=75,xfs.copy(f,T);case 75:if(console.log("[%s] Initialized baseline image: %s",g,T),v){c.next=80;break}return c.next=79,xfs.removeFile(n);case 79:v=!0;case 80:c.next=85;break;case 82:c.prev=82,c.t0=c["catch"](70),console.error("[%s] Could not copy baseline image: %s %s".red.bold,g,T,c.t0);case 85:O=!0,c.next=63;break;case 88:c.next=94;break;case 90:c.prev=90,c.t1=c["catch"](61),P=!0,Q=c.t1;case 94:c.prev=94,c.prev=95,!O&&R["return"]&&R["return"]();case 97:if(c.prev=97,!P){c.next=100;break}throw Q;case 100:return c.finish(97);case 101:return c.finish(94);case 102:if(V=["Archive received"],!w){c.next=126;break}if(V[0]=V[0]+" (merged)",!w.length){c.next=126;break}for(V.push("WARNINGS:"),W=!0,X=!1,Y=void 0,c.prev=110,Z=(0,_getIterator3["default"])(w);!(W=($=Z.next()).done);W=!0)_=$.value,V.push("    "+_);c.next=118;break;case 114:c.prev=114,c.t2=c["catch"](110),X=!0,Y=c.t2;case 118:c.prev=118,c.prev=119,!W&&Z["return"]&&Z["return"]();case 121:if(c.prev=121,!X){c.next=124;break}throw Y;case 124:return c.finish(121);case 125:return c.finish(118);case 126:for(aa=!0,ba=!1,ca=void 0,c.prev=129,da=(0,_getIterator3["default"])(V);!(aa=(ea=da.next()).done);aa=!0)fa=ea.value,console.log("[%s] %s",g,fa);c.next=137;break;case 133:c.prev=133,c.t3=c["catch"](129),ba=!0,ca=c.t3;case 137:c.prev=137,c.prev=138,!aa&&da["return"]&&da["return"]();case 140:if(c.prev=140,!ba){c.next=143;break}throw ca;case 143:return c.finish(140);case 144:return c.finish(137);case 145:b.status(200).send(V.join("\n"));case 146:case"end":return c.stop()}},c,this,[[61,90,94,102],[70,82],[95,,97,101],[110,114,118,126],[119,,121,125],[129,133,137,145],[138,,140,144]])})},{key:"_queueDownload",value:function(a,b){var c=this;return c._queueOperation(function(){return co(c._download(a,b))["catch"](function(a){console.error(a.stack||a),b.status(500).send("Error downloading archive - see server log for more information")})})}},{key:"_download",value:_regenerator2["default"].mark(function d(a,b){var c,e,f,g,h,i,j,k,l,m;return _regenerator2["default"].wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(c=this,e=a.body,f=e.storageKey,g=e.root,h=c._getStorage(),g){d.next=7;break}if(f?h[f]?g=h[f].path:i="Invalid storage key: "+f:i="Cannot download files without either a root directory or a storage key",!i){d.next=7;break}return console.error(i),b.status(500).send(i),d.abrupt("return");case 7:return j=File.join(storageRoot,g,e.path),k=j+".zip",d.next=11,xfs.exists(j);case 11:if(l=d.sent,!l){d.next=25;break}return d.next=15,xfs.exists(k);case 15:if(m=d.sent){d.next=22;break}return d.next=19,Zip.fromDir(j);case 19:b.download(k),d.next=23;break;case 22:b.download(k);case 23:d.next=26;break;case 25:b.status(404).send("Not found: "+j);case 26:case"end":return d.stop()}},d,this)})},{key:"_queueUpdateBaseline",value:function(a,b){var c=this;return c._queueOperation(function(){return co(c._updateBaseline(a,b))["catch"](function(a){console.error(a.stack||a),b.json({success:!1,message:"Cannot update baseline image. "+a})})})}},{key:"_updateBaseline",value:_regenerator2["default"].mark(function e(a,b){var c,d,f,g,h,i,j,k,l,m,n,o;return _regenerator2["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(c=this,d=a.body,f=d.storageKey,g=d.screenshot,h=d.buildNumber,i=d.archivePath,j=c._getStorage(),j[f]){e.next=6;break}return b.json({success:!1,message:"Invalid storage key: "+f}),e.abrupt("return");case 6:o=j[f].path;case 7:return n=File.join(storageRoot,o,i),k=File.join(n,"baseline"),m=File.join(n,h,g),l=File.join(k,g),l=l.replace(/-baseline.png$/,".png"),e.next=14,xfs.exists(m);case 14:if(!e.sent){e.next=22;break}return e.next=17,xfs.copy(m,l);case 17:return e.next=19,xfs.removeFile(k+".zip");case 19:b.json({success:!0}),e.next=23;break;case 22:b.json({success:!1,message:"Cannot update baseline image.  Actual does not exist: "+m});case 23:case"end":return e.stop()}},e,this)})},{key:"_initCatalogs",value:function(){var a=this._getStorage(),b=(0,_keys2["default"])(a);b.forEach(function(b){var c,d,e=a[b].path;e.startsWith("/")&&(e=e.substring(1)),c=new File(storageRoot).join(e).join("catalog.json"),d=Catalog.getCatalog(c),d.save()})}},{key:"_getStorage",value:function(){var a=this;if(!a._storage){var b,c;try{b=xfs.join(serverDir,"storage.json"),c=fs.readFileSync(b)}catch(d){console.error("Error loading storage config from "+b),process.exit(1)}try{a._storage=JSON.parse(c)}catch(d){console.error("Error parsing "+b),console.error(d.stack||d),process.exit(1)}}return a._storage}},{key:"stop",value:function(){var a=this.app;a&&a.close()}},{key:"dtor",value:function(){this.stop()}}]),b}(Base);module.exports=ServerCommand;