"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Observable=require("../../Observable"),File=require("orion-core/lib/fs/File"),Json=require("orion-core/lib/Json"),appJsTemplate=new File(__dirname).join("app.js.handlebars"),BuildProfile=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this;(0,_assign2["default"])(a,{displayName:a.name||"default",watching:!1,building:!1,rootUrl:null,watchTask:null,type:a.owner.isApp?"app":"package",displayType:a.owner.isApp?"App":"Package",tasks:{}})}},{key:"getBuildCommand",value:function(a,b,c,d){return[a,b,d?"-clean":null,this.name,c].filter(function(a){return!!a})}},{key:"_buildLogMessage",value:function(a,b){var c=this,d=a.message.message,e="Writing content to ",f="Appending content to ";if(d)if(d.startsWith(e)&&!c.bootstrapFile){var g=d.substring(e.length);g.endsWith(".json")&&(c.bootstrapFile=g)}else if(!c.bootstrapFile&&d.startsWith(f)){var g=d.substring(f.length);g.endsWith(".json")&&(c.bootstrapFile=g)}}},{key:"_watchLogMessage",value:function(a,b){var c=this,d=a.message.message,e="Waiting for changes...",f="Application available at ";if(d&&(d.startsWith(e)?(c.building=!1,c.fire({type:"watchIdle",task:b,profile:c}),c._buildUnitTestFiles(),c.bootstrapFile=null):(c.building=!0,c.fire({type:"watchBuild",task:b,profile:c})),d.startsWith(f))){var g=d.substring(f.length);g.endsWith("/")||(g+="/"),c.rootUrl=g,c.fire({type:"rootUrl",url:g,profile:c})}}},{key:"_resetWatchStatus",value:function(){(0,_assign2["default"])(this,{watchStarted:!1,watching:!1,building:!1,watchTask:null,rootUrl:null})}},{key:"setBuildTask",value:function(a,b){var c=this;a.on({scope:this,complete:function(a){b||c._buildUnitTestFiles(),c.bootstrapFile=null},logMessage:function(b){c._buildLogMessage(b,a)}})}},{key:"setWatchTask",value:function(a){var b=this;b.watchTask=a,b.watching=!0,b.fire({type:"watchStarted",task:a,profile:b}),a.on({scope:b,complete:function(c){b._resetWatchStatus(),b.fire({type:"watchDone",task:a,profile:b})},logMessage:function(c){b._watchLogMessage(c,a)}}),b.setBuildTask(a,!0)}},{key:"_getAppJsFile",value:function(a){return this.owner._getBuildDir(a).join("app.js")}},{key:"_extractAppJs",value:function(){var a=this,b=a.owner,c=a.name;return b._extractTemplate(appJsTemplate,a._getAppJsFile(c),c)}},{key:"_buildUnitTestFiles",value:function(){var a=this,b=a.owner,c=a.name,d=a.bootstrapFile,e=b._getBuildDir(c),f=function(a){console.error(a.stack||a)};d&&b._extractBuildIndex(c).then(function(g){a._extractAppJs().then(function(a){Json.read(d).then(function(a){var d,h=new File(b._getBuildDir(c)).join("manifest.json"),i=new File(b.dir),j=b.data.js,k={},l=a.js,m=(a.css,a.paths,[]),n=-1,o=0,p=!1,q=a.loadOrder,r=[];if(d=i.relativeTo(g.getParent()).slashify()+"/",j&&j.length&&j.forEach(function(a){if(a.bundle){var b=i.join(a.path);k[b.getCanonicalPath()]=a}}),l.forEach(function(a){if(!a.remote){var b=i.join(a.path);if(k[b.getCanonicalPath()])return void(p||(p=!0,n=o))}m.push(a),o++}),q&&q.length)for(var s=q.length,t=0;t<s;t++){var u=q[t],v=i.join(u.path);k[v.getCanonicalPath()]&&u.path.endsWith("app.js")&&(r.push({path:d+"app.js"}),q.push({idx:q.length,path:d+"app.js",requires:u.requires,uses:u.uses}))}else r.push({path:d+"app.js"});n>-1?m.splice.apply(m,[n,0].concat(r)):m.push.apply(m,r),a.js=m,h.write((0,_stringify2["default"])(a)),i.join(".sencha/app/Boot.js").read().then(function(a){i.join(".sencha/app/Microloader.js").read().then(function(b){e.join("bootstrap.js").write(a+"\n"+b)},f)},f)},f)},f)},f)}}]),b}(Observable);module.exports=BuildProfile;