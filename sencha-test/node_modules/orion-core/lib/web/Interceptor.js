"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Base=require("../Base"),http=require("http"),Buffer=require("buffer").Buffer,Interceptor=function(a){function b(a){(0,_classCallCheck3["default"])(this,b);var c=(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).call(this,a));(0,_assign2["default"])(c,a);var d=c,e=d.target;return d._buffer="",d.hook(["writeHead","setHeader","write","end"]),e instanceof http.ServerResponse?d._targetIsResponse=!0:e.isInterceptor&&(d._targetIsInterceptor=!0),c}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"hook",value:function(a){var b=this,c=b.target;a.forEach(function(a){b[a]&&(b["__"+a]=c[a].bind(c),c[a]=b[a].bind(b))})}},{key:"setHeader",value:function(a,b){var c=this.headers||(this.headers={});c[a]=b}},{key:"writeHead",value:function(a,b){this.code=a,b&&(this.headers?(0,_assign2["default"])(this.headers,b):this.headers=b)}},{key:"write",value:function(a,b){this._buffer+=a.toString()}},{key:"end",value:function(a,b){a&&"function"==typeof a&&(b=a,a=null),a&&this.write(a),this.done()}},{key:"applyHeaders",value:function(a){var b,c=this;a&&(0,_keys2["default"])(a).forEach(function(d){b=a[d],c.headers[d]=b})}},{key:"flushHeaders",value:function(){var a,b=this,c=b.headers;(0,_keys2["default"])(c).forEach(function(d){a=c[d],b.__setHeader(d,a)})}},{key:"done",value:function(){function a(a){e=(a.stack||a).toString(),c.code=500,c.setHeader("Content-Type","text/plain")}function b(a){if(c._targetIsResponse){if(a){var b=Buffer.byteLength(a);c.setHeader("content-length",b.toString())}c.applyHeaders(c.headers),c.applyHeaders(c.context&&c.context.headers),c.flushHeaders(),c.__writeHead(c.code||d.statusCode||200,c.headers),a?c.__write(a,function(){c.__end()}):c.__end()}else d.write(a),d.done()}var c=this,d=c.target,e=c._buffer;if(e&&c.prepareData)try{e=c.prepareData.call(c,e,d),e&&"function"==typeof e.then?e.then(function(a){b(a)})["catch"](function(c){a(c),b(e)}):b(e)}catch(f){a(f),b(e)}else b()}}]),b}(Base);Interceptor.prototype.isInterceptor=!0,module.exports=Interceptor;