"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_defineProperty2=require("babel-runtime/helpers/defineProperty"),_defineProperty3=_interopRequireDefault(_defineProperty2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),File=require("./fs/File"),xfs=require("./xfs"),Base=require("./Base"),Json=require("./Json"),Util=require("./Util"),DEFAULT={},Settings=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a,b=this,c=b.defaults,d=Util.clone(c);try{b.filePath=File.get(b.filePath),b.filePath.ensurePathExistsSync(),b._file=a=b.filePath.join(b.fileName),b.settings=Json.readSync(a.getPath()),b.settings=Util.merge(d,b.settings),b.validate()}catch(e){(b.logger||console).error(e.message),b.settings=d,b.save()}}},{key:"flush",value:function(){this._saveTimer&&this.save()}},{key:"get",value:function(a){var b=this.settings;return a?b[a]:b}},{key:"set",value:function(a,b){var c,b,d=this.settings;"string"==typeof a&&(a=(0,_defineProperty3["default"])({},a,b));for(c in a)b=a[c],void 0===b?delete d[c]:d[c]=b}},{key:"save",value:function(){var a=this,b=a.validate();return a._saveTimer&&(clearTimeout(a._saveTimer),a._saveTimer=null),b=a.removeDefaults(Util.clone(b),a.defaults),Json.writeSync(this._file.getPath(),b),this}},{key:"saveSoon",value:function(){var a=this;a._saveTimer&&clearTimeout(a._saveTimer),a._saveTimer=setTimeout(a.onSaveTick.bind(a),1e3)}},{key:"onSaveTick",value:function(){this._saveTimer=null,this.save()}},{key:"removeDefaults",value:function(a,b){var c,d,e=this;if(a===b)return DEFAULT;if(null!=b)if(Array.isArray(a)){if(Array.isArray(b)&&(c=a.length,a.forEach(function(a,d){DEFAULT===e.removeDefaults(a,b[d])&&--c}),!c))return DEFAULT}else if(null!=a&&"object"===("undefined"==typeof a?"undefined":(0,_typeof3["default"])(a))&&"object"===("undefined"==typeof b?"undefined":(0,_typeof3["default"])(b))){c=0;for(d in a)DEFAULT===e.removeDefaults(a[d],b[d])?delete a[d]:++c;if(!c)return DEFAULT}return a}},{key:"validate",value:function(){return this._validate(this.settings,this.validators)}},{key:"_validate",value:function(a,b){var c,d,e,f,g=this,h=a,i="function"==typeof b;if(a&&a.constructor===Object){i?(a=b(a),b=null):b&&b.constructor===Object||(b=null);for(d in a)a[d]=g._validate(a[d],b&&b[d])}else if(a&&Array.isArray(a))for(i?(e=b,b=null):Array.isArray(b)||(b=null),c=0,d=a.length;c<d;++c)f=a[c],a[c]=e?e.call(g,f):g._validate(f,b&&b[c]);else i&&(h=b.call(g,h));return h}}],[{key:"meta",get:function(){return{prototype:{isSettings:!0,defaults:{},fileName:"settings.json",filePath:xfs.profileDir,validators:{}}}}}]),b}(Base);module.exports=Settings;