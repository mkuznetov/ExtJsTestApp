"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),App=require("orion-core/lib/model/cmd/App"),ArchiveReporter=require("orion-core/lib/reporter/ArchiveReporter"),CmdClient=require("orion-core/lib/cmd/Client"),CmdManager=require("orion-core/lib/cmd/Manager"),File=require("orion-core/lib/fs/File"),Observable=require("orion-core/lib/Observable"),Project=require("orion-core/lib/model/test/Project"),Runner=require("orion-core/lib/test/Runner"),SandboxRunner=require("orion-core/lib/test/SandboxRunner"),Workspace=require("orion-core/lib/model/Workspace"),xfs=require("orion-core/lib/xfs"),Url=require("url"),JUnitReporter=require("./reporter/JUnitReporter"),TeamCityReporter=require("./reporter/TeamCityReporter"),TextReporter=require("./reporter/TextReporter"),reporterMap={archive:ArchiveReporter,junit:JUnitReporter,teamcity:TeamCityReporter,text:TextReporter},console=require("orion-core/lib/util/console-manager").console,RunCommand=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"execute",value:function(){var a=this,b=a.scenarioDir,c=a.poolName,d=a.cmdManager=new CmdManager;a.cmdPath&&(d.current=new CmdClient({manager:d,directory:a.cmdPath})),Workspace.find(b).then(function(a){return Workspace.load(a)}).then(function(d){d.error&&(console.error(d.error),process.exit(1));var e=d.getTestScenario(b);a._assertNotNull(e,"No test scenario found on "+b);var f=a._getPool(c,d),g=a._getArchivePath(d,e.project.owner);a._runScenario(e,{pool:f,output:a.output,archivePath:g})})["catch"](function(a){console.error(a.stack||a),process.exit(1)})}},{key:"_getArchivePath",value:function(a,b){var c="",d=a.get("tests");if(d&&d.archivePath&&(c=d.archivePath),b.isApp||b.isPackage){var e=b.get("tests");e&&e.archivePath&&(c+=e.archivePath)}return c}},{key:"_runScenario",value:function(a,b){var c=this,d=b.archivePath,e=b.pool,f=c._getRunner(a,d),g=new _promise2["default"](function(a,b){f.startProxy(),f.proxy.on("started",function(b){a(b.port)}),f.proxy.on("error",function(a){console.error(a.stack||a),b(a)})});f.on("terminated",function(a){var b=a.passed;_promise2["default"].all([f.archiver.flush(),e.farm.stopTunnel?e.farm.stopTunnel():_promise2["default"].resolve()]).then(function(a){a.forEach(function(a){a&&console.log(a)}),setTimeout(function(){process.exit(b?0:1)},1e3)})["catch"](function(a){console.error(a.stack||a),setTimeout(function(){process.exit(1)},1e3)})}),g.then(function(b){var c=a.project.owner;if(c.isApp&&c.get("launchAppWatch"))return c.launch(a.get("profile"))}).then(function(){var b={globals:a.getGlobals()};return f.startTestRun({files:a.getFiles(),browsers:e.browsers,enableCodeCoverage:c.coverage,testOptions:b})})["catch"](function(a){console.error(a.stack||a),process.exit(1)})}},{key:"_getRunner",value:function(a,b){var c,d=this,e=Array.isArray(d.output)?d.output:[d.output],f=a.getCalculatedTargetUrl(),g=Url.parse(f),h=new ArchiveReporter({id:d.buildNumber,scenario:a,server:d.archiveServer,storageKey:d.storageKey,archivePath:b,overwrite:d.overwrite,workdir:d.workdir,baselinedir:d.baselinedir&&new File(d.baselinedir)}),i=[h];e.forEach(function(c){"archive"!==c&&i.push(new reporterMap[c]({scenario:a,archivePath:b}))}),g.hostname||(c=!0);var j=a.get("sandbox")?SandboxRunner:Runner,k=new j({scenario:a,cmdClient:d.cmdManager.current,archiver:h,reporter:i,noProxy:c,callbackAddress:d.callbackAddress,enableCodeCoverage:d.coverage,autoStartTunnel:d.autoStartTunnel,remoteTimeout:d.timeout});return k}},{key:"_assertNotNull",value:function(a,b){null==a&&(console.error(b),process.exit())}},{key:"_getPool",value:function(a,b){var c=this,d=[];b.eachFarm(function(b){d=d.concat(b.getPools(a))});var e=c._validatePool(d,a,b);return c.username&&e.farm.set("username",c.username),c.accessKey&&e.farm.set("accessKey",c.accessKey),e}},{key:"_validatePool",value:function(a,b,c){var d,e,f,g,h=a.length||0,i=h&&a[0],j=[];for(d=0;d<h;d++)if(f=a[d].name.toLowerCase(),g=b.toLowerCase(),f===g){i=a[d],e=!0;break}return b?i?!e&&h>1?j.push("Multiple pools found by name: "+b):i.farm||j.push("Pool "+i.name+" is not associated with a browser farm"):j.push("No such browser pool: "+b):j.push("No browser pool was specified"),j.length&&(j.push(""),j.push("Available browser pools:"),c.eachFarm(function(a){j.push("    "+a.get("name")),a.eachPool(function(a){j.push("        "+a.name)})}),console.error(j.join("\n")),process.exit(1)),i}}]),b}(Observable);module.exports=RunCommand;