"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Base=require("../Base"),fs=require("fs"),Util=require("orion-core/lib/Util"),_ProcessUtil=function(){var a=require("orion-core/lib/process/ProcessUtil");return _ProcessUtil=function(){return a},a},Operations=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"getStat",value:function(){var a=this;return new _promise2["default"](function(b,c){fs.stat(a.path,function(a,c){b(a?!1:c)})})}},{key:"ensurePathExists",value:function(){var a=this,b=a.parent;return new _promise2["default"](function(c,d){function e(){a.path?a.exists().then(function(b){b?c(a):fs.mkdir(a.path,function(b){b&&"EEXIST"!==b.code?d(b):c(a)})},d):c(!1)}b?b.ensurePathExists().then(function(){e()},d):e()})}},{key:"write",value:function(a,c){var d=this,e=d.parent,f=d.path;return new _promise2["default"](function(g,h){function i(){fs.writeFile(f,a,c,function(a){a?h(b.wrapError(f,a)):g(d)})}e?e.ensurePathExists().then(i,h):i()})}},{key:"writeJson",value:function(a,b){var c=b&&b.prettyPrint?(0,_stringify2["default"])(a,null,4):(0,_stringify2["default"])(a);return this.write(c,b).then(function(){return a})}},{key:"read",value:function(a){var b=this;return new _promise2["default"](function(c,d){fs.readFile(b.path,(0,_assign2["default"])({encoding:"utf8"},a),function(a,b){a?d(a):c(b)})})}},{key:"readJson",value:function(a){return this.read(a).then(function(a){return JSON.parse(a)})}},{key:"exists",value:function(){var a=this;return new _promise2["default"](function(b,c){fs.access(a.path,fs.F_OK,function(a){b(a?!1:!0)})})}},{key:"getFiles",value:function(a){var b=this;return new _promise2["default"](function(c,d){var e=[];fs.readdir(b.path,function(f,g){f?d(f):(g.forEach(function(c){var d=new b.constructor(b,c);e.push(new _promise2["default"](function(b,c){d.getStat().then(function(e){d.stat=e,a&&e.isDirectory()?d.getFiles(!0).then(function(a){d.items=a,b(d)},c):b(d)},function(a){c(a)})}))}),_promise2["default"].all(e).then(function(a){a.sort(b.constructor.fileStatSorter),c(a)},d))})})}},{key:"_removeDirWin",value:function(){var a=this,b=a.getCanonicalPath();return new _promise2["default"](function(a,c){var d=_ProcessUtil().spawn("rmdir",["/S","/Q",b]);d.on("exit",function(){a(0!=d.exitCode?!1:!0)})})}},{key:"_removeDirUnix",value:function(){var a=this,b=a.getCanonicalPath();return new _promise2["default"](function(a,c){var d=_ProcessUtil().spawn("rm",["-fr",b]);d.on("exit",function(){a(0!=d.exitCode?!1:!0)})})}},{key:"removeDir",value:function(){var a=this,b=a.getCanonicalPath();return Util.isWin?a._removeDirWin(b):a._removeDirUnix(b)}},{key:"remove",value:function(){var a=this,b=a.path;return new _promise2["default"](function(c,d){a.getStat().then(function(e){e?e.isDirectory()?Util.isWin?a._removeDirWin(b).then(c,d):a._removeDirUnix(b).then(c,d):fs.unlink(b,function(a){a?d(a):c(!0)}):c(!0)})})}},{key:"removeOnExit",value:function(){var a=this;process.once("beforeExit",function(){a.remove()}),process.on("exit",function(){try{a.removeSync()}catch(b){}})}}],[{key:"wrapError",value:function(a,b){var c,d='Failed to read "'+a+'"';return b instanceof Error?(b.message?b.message.indexOf(a)<0&&(b.message=d+": "+b.message):b.message=d,c=b):"string"==typeof b?c=b.indexOf(a)<0?new Error(d+": "+b):new Error(b):(c=new Error(d),c.details=b),c}}]),b}(Base);module.exports=Operations;