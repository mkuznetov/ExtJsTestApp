"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Pool=require("orion-core/lib/model/farm/Pool"),EmbeddedBrowser=require("orion-core/lib/model/browser/Embedded"),Task=require("orion-core/lib/tasks/Task"),ChildProcessTask=require("orion-core/lib/tasks/ChildProcessTask"),xfs=require("orion-core/lib/xfs"),Json=require("orion-core/lib/Json"),webdriverio=require("webdriverio"),Farm=require("./Farm"),path=require("path"),selenium=require("selenium-standalone"),portfinder=require("portfinder"),util=require("util"),Util=require("orion-core/lib/Util"),File=require("orion-core/lib/fs/File"),fs=require("fs"),Embedded=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this,b=a.data;b.name=b.name||"Embedded",b.type=b.type||"embedded",b.host=b.host||"localhost",a.set("defaultSeleniumBasePath",xfs.seleniumDir),a.set("seleniumBasePath",xfs.seleniumDir)}},{key:"driverConfig",value:function(a){var c=(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"driverConfig",this).call(this,a),d=c.desiredCapabilities;return"chromium"===d.browserName&&(d.browserName="chrome"),c}},{key:"getSeleniumServerJarName",value:function(a){return a+"-server.jar"}},{key:"getChromeDriverName",value:function(a){return a+"-"+process.arch+"-chromedriver"}},{key:"_scaffoldSelenium",value:function(a){var b,c,d,e,f=this,g=!1;return c=f.get("seleniumBasePath"),c&&xfs.existsSync(c.path)?(e=c.join("selenium-config.json"),d=c.join("logging.properties"),e&&xfs.existsSync(e.path)&&d&&xfs.existsSync(d.path)?b=Json.readSync(e.path):g=!0):g=!0,new _promise2["default"](function(a,d){if(g){var e,h,i,j,k,l,m=c.join("selenium-config.json"),n=c.join("logging.properties"),o=c.join("selenium-server"),p=c.join("chromedriver"),q=xfs.filesDir.join("selenium"),r=q.join("selenium-config.json");f.seleniumConfig=Json.readSync(r.path),o.ensurePathExistsSync(),p.ensurePathExistsSync(),j=f.getSeleniumServerJarName(f.seleniumConfig.hub.version),k=o.join(j),e=q.join("selenium-server").join(j),i=f.getChromeDriverName(f.seleniumConfig.node.drivers.chrome.version),l=p.join(i),h=q.join("chromedriver").join(i),xfs.copy(e,k).then(function(){return xfs.copy(h,l)}).then(function(){return fs.chmod(l.path,"0755")}).then(function(){return xfs.copy(q.join("selenium-config.json"),m)}).then(function(){return xfs.copy(q.join("logging.properties"),n)}).then(function(){a()})}else f.seleniumConfig=b,a()})}},{key:"startHub",value:function(){var a=this,b=(a.seleniumBasePath,a.hubConfig);return new _promise2["default"](function(c,d){selenium.start(b,function(b,e){b?d(b):(a.seleniumHub=e,c(a))})})}},{key:"startNode",value:function(a,b){var c=this,a=a||"http://localhost",b=b||4444,d=util.format("%s:%s/grid/register",a,b),e=(c.seleniumBasePath,c.nodeConfig);return new _promise2["default"](function(a,b){e.seleniumArgs=["--","-role","node","-hub",d],selenium.start(e,function(d,e){d?b(d):(c.seleniumNode=e,a(e))})})}},{key:"_installSelenium",value:function(){var a=this,b=new Task;return b.setDescription("Selenium Installer"),new _promise2["default"](function(c,d){selenium.install({basePath:a.seleniumBasePath.path},function(a,d){if(a)b.error(a);else{var e=(0,_stringify2["default"])(d,null,4);e.split("\n").forEach(function(a){b.debug(a)})}b.done(),c()})})}},{key:"_startStandaloneServer",value:function(){var a=this,b=a._getStandaloneServerTask();return new _promise2["default"](function(c,d){b.running?c(b):(b.on({scope:a,single:!0,running:function(){c(b)}}),b.on({scope:a,single:!0,error:function(a){d(a.error)}}))})}},{key:"_getStandaloneServerTask",value:function(){var a=this,b=a._task;return b||(b=a._task=new ChildProcessTask({description:"Selenium Server",launchProcess:a._startSelenium.bind(a),onStderrData:function(a){this.onStdoutData(a)}}),a.onTaskStart(b),b.on({scope:a,complete:function(){a.onTaskStop(),a._task=null}})),b}},{key:"_startSelenium",value:function(){var a=this;return new _promise2["default"](function(b,c){portfinder.basePort=4450,portfinder.getPort(function(d,e){var f=a.nodeConfig;a._task.setDescription("Selenium Server @ "+e),a.set("port",e),f.seleniumArgs=["-port",e||4450],selenium.start(f,function(a,d){a?c(a):b(d)})})})}},{key:"start",value:function(){var a=this;return a._scaffoldSelenium().then(function(){return!0}).then(function(){return a._startStandaloneServer()})}},{key:"stop",value:function(){var a=this,b=a._task;b&&b.stop()}},{key:"connectionDisplay",get:function(){return"Embedded"}},{key:"hubConfig",get:function(){var a=this.seleniumConfig?this.seleniumConfig.hub||{}:{};return a.seleniumArgs=["--","-role","hub"],a}},{key:"nodeConfig",get:function(){var a=this.seleniumConfig?this.seleniumConfig.node||{}:{},b=this.get("seleniumBasePath").path;return a.basePath=b,a.javaArgs=["-Djava.util.logging.config.file="+path.join(b,"logging.properties")],a}}],[{key:"meta",get:function(){return{prototype:{isPowerable:!0}}}}]),b}(Farm);module.exports=Embedded;