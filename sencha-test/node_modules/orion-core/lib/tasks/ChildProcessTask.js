"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Task=require("./Task"),ProcessUtil=require("../process/ProcessUtil"),platform={isMac:/^darwin/.test(process.platform),isWin:/^win/.test(process.platform)},ChildProcessTask=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this;a._init().then(function(b){a.proc=b,b.stdout.on("data",a.onStdoutData.bind(a)),b.stderr.on("data",a.onStderrData.bind(a)),b.on("error",a.onError.bind(a)),b.on("close",a.onClose.bind(a)),b.on("exit",a.onExit.bind(a)),a._set("running",!0),a.fire("running")})["catch"](function(b){(b.stack||b).toString();a.onError(b),a.error(b),a._set("running",!1)})}},{key:"_init",value:function(){var a=this;return new _promise2["default"](function(b,c){var d=a.proc;if(d)b(d);else try{d=a.launchProcess(),d instanceof _promise2["default"]?d.then(function(a){b(a)},function(a){c(a)}):b(d)}catch(e){c(e)}})}},{key:"launchProcess",value:function(){var a=this;return ProcessUtil.spawn(a.executable,a.args,a.opts)}},{key:"parseMessage",value:function(a,b){if(a=a?a.trim():"",this.cmdFormatted){var c=this.messageRe,d=c.exec(a);d&&(b=d[1],a=a.replace(c,"").trim())}return{message:a,level:b}}},{key:"getLines",value:function(a,b){var c=this,d=[],e=a.split("\n");return e.forEach(function(a){var e=c.parseMessage(a,b);e.message&&d.push(e)}),d}},{key:"onStdoutData",value:function(a){var b,c=this,d=a.toString(),e=c.stdoutLevel;c.fire({type:"stdout",message:d});try{b=JSON.parse(d)}catch(f){}b?c.fire({type:"logMessage",message:{message:(0,_stringify2["default"])(b,null,2),time:(new Date).getTime(),level:e,description:c.description,type:"stdout",format:"json"}}):c.getLines(d,e).forEach(function(a){c.fire({type:"logMessage",message:{message:a.message,time:(new Date).getTime(),level:a.level,description:c.description,type:"stdout"}})})}},{key:"onStderrData",value:function(a){var b=this,c=a.toString(),d=b.stderrLevel;b.fire({type:"stderr",message:c}),b.getLines(c,d).forEach(function(a){b.fire({type:"logMessage",message:{message:a.message,time:(new Date).getTime(),level:a.level,description:b.description,type:"stderr"}})})}},{key:"onClose",value:function(a,b){var c=this;c.exitCode=a,c.signal=b,c.fire({type:"closed",exitCode:a,signal:b,task:c}),c.done()}},{key:"onExit",value:function(a,b){var c=this;c.exitCode=a,c.signal=b,c.fire({type:"exit",exitCode:a,signal:b,task:c})}},{key:"onError",value:function(a){this.fire({type:"error",error:a,task:this})}},{key:"stop",value:function(){var a=this,b=a.proc;if(a._set("forcedStopped",!0),a.running)try{ProcessUtil.kill(b.pid),b.kill(),a.done()}catch(c){console.error(c.stack||c)}else a.done()}}],[{key:"meta",get:function(){return{prototype:{stdoutLevel:"info",stderrLevel:"error",messageRe:/^\[([a-zA-Z]{3})\]/g}}}}]),b}(Task);ChildProcessTask.prototype.isChildProcessTask=!0,module.exports=ChildProcessTask;