"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Crypto=require("crypto"),Path=require("path"),Uuid=require("uuid"),Entity=require("orion-core/lib/model/Entity"),Observable=require("orion-core/lib/Observable"),File=require("orion-core/lib/fs/File"),Mac=require("orion-core/lib/license/Mac"),PUBLIC_KEY=Path.resolve(__dirname,"..","..","keys","publickey.pem"),trialRe=/trial/i,typeRe=/^(trial|paid)$/i,License=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this.data,b=a.print;a.id=a.id||Uuid.v4(),b&&(delete a.print,a.fingerprint=b)}},{key:"activate",value:function(a,b){var c=this;return c.activationRequest(a,b).then(function(a){return c.manager.request(a).then(function(a){return c.activateWith(a.license)})})}},{key:"activationRequest",value:function(a,b){var c=this,d=c.data,e=d.product,f={email:d.email,id:c.id,product:{code:e.code,version:e.version}};return a&&(f.activationCode=a),b&&(f.validation=b),c.mac.getFingerprint().then(function(a){return f.print=a,f})}},{key:"activateWith",value:function(a){var b=this,c=b.data,d=(0,_assign2["default"])({},c),e=a.signature,f=a.print||a.fingerprint,g=a.schema||a.version;return d.product&&"object"===(0,_typeof3["default"])(d.product)&&(d.product=(0,_assign2["default"])({},d.product)),a.email!==c.email?_promise2["default"].reject(new Error("License email does not match")):a.id?1!==g?_promise2["default"].reject(new Error("License format not recognized")):f?typeRe.test(a.type)?"string"!=typeof e||e.length<20?_promise2["default"].reject(new Error("License does not have a valid signature")):(c.id=a.id,c.schema=g,c.expiration=a.expiration,c.fingerprint=f,c.signature=a.signature,c.type=a.type,(0,_assign2["default"])(c.product,a.product),b.verify().then(function(a){var c=b.problem;if(c)throw b.data=d,new Error("Cannot activate license: "+c);return b.fire("activate"),b.manager.onActivate(b),b})):_promise2["default"].reject(new Error("License is not of a recognized type")):_promise2["default"].reject(new Error("License is missing machine fingerprint")):_promise2["default"].reject(new Error("License does not contain an id"))}},{key:"remove",value:function(a){this.manager.remove(this,a)}},{key:"serialize",value:function(){var a=this.data;return{id:a.id,schema:this.schemaVersion,email:a.email,expiration:a.expiration,fingerprint:a.fingerprint,product:a.product,signature:a.signature,type:a.type}}},{key:"setValidity",value:function(a){var b=this,c=b.validity;c&&c.problems===a.problems&&c.fingerprint===a.fingerprint||(b.validity=a,b.fire("validitychange",{previous:c}))}},{key:"verify",value:function(){var a,b,c=this,d={problems:""};return c.expired&&(d.problems+="E",d.expired=!0),c.manager.timeBomb?(c.setValidity(d),_promise2["default"].resolve(d)):(d.signature=!0,c.signature&&(a=c.getSignData(),b=Crypto.createVerify("RSA-SHA1"),b.update(a),b.verify(c.pubKey,c.signature,"base64")&&delete d.signature),d.signature&&(d.problems+="S"),c.mac.verify(c.fingerprint).then(function(a){return a||(d.problems+="F",d.fingerprint=!0),c.setValidity(d),d},function(a){return d.problems+="F",d.fingerprint=a.message,c.setValidity(d),d}))}},{key:"getSignData",value:function(){return this.constructor.getSignData(this.data)}},{key:"email",get:function(){return this.data.email}},{key:"expiration",get:function(){var a=this.data.expiration||null;return a&&Date.parse(a)}},{key:"expirationDate",get:function(){var a=this.expiration;return a&&new Date(a)}},{key:"expired",get:function(){var a=this.expiration||!1;return a&&Date.now()>=a}},{key:"id",get:function(){return this.data.id}},{key:"fingerprint",get:function(){return this.data.fingerprint}},{key:"product",get:function(){return this.data.product}},{key:"problem",get:function(){var a=this.validity,b=null,c=a&&a.fingerprint;return a?a.signature?b="License is corrupted":c===!0?b="License is not valid for this machine":c?b="License failed verification: "+c:a.expired&&(b="License has expired"):b="License has not been verified",b}},{key:"schemaVersion",get:function(){return this.constructor.schemaVersion}},{key:"signature",get:function(){return this.data.signature}},{key:"trial",get:function(){return trialRe.test(this.data.type)}}],[{key:"grok",value:function(a){return a.email||a.schema===this.schemaVersion}},{key:"concatFields",value:function(a,b){var c=this,d=[];return b.forEach(function(b){var e;if("string"==typeof b)e=a[b];else if(Array.isArray(b)){var f=!0,g=!1,h=void 0;try{for(var i,j=(0,_getIterator3["default"])(b);!(f=(i=j.next()).done);f=!0){var k=i.value;if(void 0!==(e=a[k]))break}}catch(l){g=!0,h=l}finally{try{!f&&j["return"]&&j["return"]()}finally{if(g)throw h}}}else e=c.concatFields(a[b.name],b.fields);e instanceof Date&&(e=e.toISOString()),null==e?d.push("*"):d.push(e)}),"{"+d.join("}{")+"}"}},{key:"getSignData",value:function(a){return this.concatFields(a,this.signFields)}},{key:"meta",get:function(){return{mixins:[Observable],prototype:{isLicense:!0,mac:new Mac,pubKey:new File(PUBLIC_KEY).readSync(),validity:null},statics:{schemaVersion:1,signFields:["id","email","expiration",["fingerprint","print"],{name:"product",fields:["activationCode","code","version"]},"type"]}}}}]),b}(Entity);module.exports=License;