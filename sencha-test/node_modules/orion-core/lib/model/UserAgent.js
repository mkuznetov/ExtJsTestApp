"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),useragent=require("express-useragent"),parse=require("user-agent-parser"),Network=require("orion-core/lib/Network.js"),Version=require("orion-core/lib/Version"),nameToIdRe=/[\.:\s\-]/g,UserAgent=function(){function a(b,c){(0,_classCallCheck3["default"])(this,a);var d=useragent.parse(b),e=parse(b),f=d.os.split(" "),g=new Version(f[f.length-1]),h=d.browser,i=d.version?new Version(d.version):Version.ZERO,j=e.os.name;0===g.major&&(e.os.version?(f=e.os.version.split(" "),g=new Version(f[f.length-1])):g=new Version("0")),this.userAgent=b,this.browser={name:h,version:i,fullName:h+" "+i.version},this.os={name:j,version:g,fullName:j+(0!=g.version?" "+g.version:"")},this.name=this.browser.fullName+" / "+this.os.fullName,this.id=this.browser.name+this.browser.version.shortVersion+this.os.name.replace(/\s/g,"")+(g.shortVersion&&"NaN"!=g.shortVersion?g.shortVersion.replace(/ /g,""):g.version.replace(/[\.\-_]/g,"")),this.local=!1,this.groupKey="",c&&(this.address=c)}return(0,_createClass3["default"])(a,[{key:"isOsEqual",value:function(b){var c=this.os,d=a.getInstance(b,this.address).os;return c.name===d.name&&c.version.major===d.version.major&&c.version.minor===d.version.minor}},{key:"browserRecord",get:function(){var a=this,b=a._browserRecord;if(!b){var c=(a.browser,a.os);b=a._browserRecord=Studio.model.Browser.wrap(new Studio.core.model.browser.Browser({name:a.browser.name,type:a.browser.name.toLowerCase(),version:a.browser.version,platformName:c.name,platformVersion:c.version}))}return b}},{key:"address",get:function(){return this._address},set:function(b){if(this._address)throw new Error("UserAgent address is already set. Unable to change UserAgent address.");this._address=b,this.groupKey=b.replace(nameToIdRe,"_"),!Network.isAddressLocal(b)||a.local&&!a.local.isOsEqual(this)||(this.groupKey="_",this.local=!0)}},{key:"fullId",get:function(){return this.id.replace(nameToIdRe,"_")+this.groupKey}}],[{key:"getInstance",value:function(b,c){var d=a.instances;if(b instanceof a)return b;c=c||"";var e=d[b]||(d[b]={});return e[c]||(e[c]=new a(b,c))}},{key:"fromRequest",value:function(b){var c=b.connection.remoteAddress;return c.startsWith("::ffff:")&&(c=c.substr(7)),a.getInstance(b.headers["user-agent"],c)}},{key:"local",get:function(){var b=a._local;return"_local"in a||(b=a._local="undefined"!=typeof navigator&&navigator.userAgent?new a(navigator.userAgent):null),b}}]),a}();UserAgent.instances={},module.exports=UserAgent;