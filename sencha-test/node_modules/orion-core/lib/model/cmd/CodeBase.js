"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Configuration=require("../../config/Configuration"),WorkspaceMember=require("../WorkspaceMember"),Testable=require("../Testable"),TargetUrl=require("../TargetUrl"),BuildProfile=require("./BuildProfile"),Handlebars=require("handlebars"),fs=require("fs"),Path=require("path"),xfs=require("../../xfs"),File=require("orion-core/lib/fs/File"),responseTemplate=new File(__dirname).join("build.response.handlebars"),depsResponseTemplate=new File(__dirname).join("deps.build.response.handlebars"),indexHtmlTemplate=new File(__dirname).join("build.html.handlebars");Handlebars.registerHelper("test",function(a,b,c){return a==b?c.fn(this):c.inverse(this)});var CodeBase=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this,b=a.getBuildNames();0===b.length&&(b=[""]),a.profiles={},b.forEach(function(b){a.profiles[b]=new BuildProfile({name:b,owner:a})})}},{key:"getTestProjectPath",value:function(){var a=this.get("development");return a=a&&a.tests,a=a&&a.path,a=a&&this.resolve(a)}},{key:"setTestProjectPath",value:function(a){var b,c=this.get("development");c||this.set("development",c={}),b=c.tests||(c.tests={}),b.path=a}},{key:"loadChildren",value:function(){var a=this,b=new Configuration,c=a.resolve(a.constructor.configPath),d=function(){return a};return _promise2["default"].all([this.loadTests(),b.load(c).then(function(b){a.configFile=b},function(a){})]).then(d,d)}},{key:"setWorkspace",value:function(a){(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"setWorkspace",this).call(this,a);var c=this.packages;c&&c.forEach(function(b){return b.setWorkspace(a)})}},{key:"hasProfiles",value:function(){return this.getBuildNames().length>0}},{key:"getBuildProfile",value:function(a){var b=this,c=b.profiles[a||""];return c||a?c:b.getBuildProfiles()[0]}},{key:"getBuildProfiles",value:function(){var a=this,b=[];return this.getBuildNames().map(function(c){b.push(a.profiles[c])}),0===b.length&&b.push(this.getBuildProfile("")),b}},{key:"getBuildNames",value:function(){var a=this,b=a.profileConfigs,c=a.data;if(c&&!b){b=[];var d=c.builds&&(0,_keys2["default"])(c.builds)||[null],e=c.themes||[null],f=c.locales||[null];d.forEach(function(a){e.forEach(function(c){f.forEach(function(d){var e=[a,c,d].filter(function(a){return!!a}).join("-");b.push(e)})})}),b=b.filter(function(a){return!!a}),a.profileConfigs=b}return b||[]}},{key:"setRootUrl",value:function(a){var b=this,c=b.rootUrl;b.rootUrl=a,b.fire({type:"rooturl",url:a,old:c})}},{key:"getProfileName",value:function(a){var b=this,c=b.getBuildProfiles(),d=b.getBuildProfile(a);return d=d||c[0],d&&d.name}},{key:"getRootUrl",value:function(){return this.rootUrl||""}},{key:"getTargetPath",value:function(){var a,b,c=this,d=c.appIndexPath;if(d||(a=c.get("indexHtmlPath"),b=c.getWorkspace().dir,d=xfs.getRelativePath(b,xfs.join(c.dir,a)),d=c.appIndexPath=xfs.normalize(d)),!d){var e=new File(c.dir).join("index.html");e.existsSync()&&(d="index.html")}return d}},{key:"getTargetUrl",value:function(){return[this.getRootUrl(),this.getTargetPath()].filter(function(a){return!!a}).join("")}},{key:"_getBuildDir",value:function(a){var b=this.workspace,c=new File(b.dir).join(".sencha").join("temp").join(this.get("name"));return a&&(c=c.join(a)),c}},{key:"_getBuildResponseFile",value:function(a){return this._getBuildDir(a).join("build.options")}},{key:"_getDepBuildResponseFile",value:function(a){return this._getBuildDir(a).join("dep.build.options")}},{key:"_getBuildIndexFile",value:function(a){return this._getBuildDir(a).join("index.html")}},{key:"getGeneratedSubjectUrl",value:function(a){a=this.getProfileName(a);var b=this.workspace;return new File(b.dir).relativeTo(this._getBuildIndexFile(a)).slashify()}},{key:"_getTemplateOptions",value:function(a,b){var c=this;return{name:c.get("name"),dir:c._getBuildDir(a),type:c.isApp?"app":"package",buildName:a,isApp:c.isApp,skipSass:b}}},{key:"_extractTemplate",value:function(a,b,c,d,e){var f=this;return new _promise2["default"](function(g,h){a.read().then(function(a){var i=Handlebars.compile(a);b.write(i((0,_assign2["default"])(e||{},f._getTemplateOptions(c,d)))).then(g,h)},h)})}},{key:"_extractBuildOptions",value:function(a,b){return this._extractTemplate(responseTemplate,this._getBuildResponseFile(a),a,b)}},{key:"_extractDepBuildOptions",value:function(a,b){return this._extractTemplate(depsResponseTemplate,this._getDepBuildResponseFile(a),a,b)}},{key:"_extractBuildIndex",value:function(a,b){var c,d=this.resolve("index.html"),e=this._getBuildIndexFile(a),f={relDir:"",relTempDir:""},g=new File(d);if(g.existsSync()){var h,i=g.readSync(),j=/<!-- <x-bootstrap> -->([\s\S]*?)<!-- <\/x-bootstrap> -->/gm;f.relDir=new File(e).relativeTo(g.getParent()).slashify()+"/",f.relTempDir=g.relativeTo(new File(e).getParent()).slashify()+"/",i&&(h=j.exec(i),h&&(c=h[1],f.bootstrap=c))}return this._extractTemplate(indexHtmlTemplate,e,a,b,f)}},{key:"_getDispatchConfig",value:function(a,b){var c=this.get("name"),d=this.isApp?"${workspace.build.dir}/temp/${build.environment}/${build.id}/"+c:"${workspace.build.dir}/temp/${build.id}/"+c,e={};return this.getBuildProfiles().length>1&&(0,_assign2["default"])(e,{"build.temp.dir":d}),{args:a,async:!0,cwd:this.dir,captureUpdates:!0,captureAntEvents:!0,captureLog:!0,description:b,params:e}}},{key:"_runDispatch",value:function(a,b){var c=this,d=c.appWatchInProcess;return a.dispatch(b,d)}},{key:"runBuild",value:function(a,b,c,d){var e,f=this,g=f.getBuildProfile(b),h=g.displayName,i=f.getName()+" "+(f.isApp?"App":"")+(f.isPackage?"Package":"")+(f.isFramework?"Framework":"")+" Build "+h+" "+(c?c:"");return f.record&&f.record.addCls("app-building"),e=f._getDispatchConfig(g.getBuildCommand(f.isApp?"app":"package","build",c,d),i),f._runDispatch(a,e).then(function(a){return a.on({scope:f,complete:function(a){f.record&&f.record.removeCls("app-building")}}),"development"==c&&g&&g.setBuildTask(a),a})}},{key:"runTestBuild",value:function(a,b,c,d){b=this.getProfileName(b);var e,f=this,g=f.getBuildProfile(b),h=g.displayName,i=f.getName()+" Test Build "+h;return new _promise2["default"](function(g,h){f._extractBuildOptions(b,c).then(function(j){f._extractBuildIndex(b,c).then(function(b){e=f._getDispatchConfig(["@"+j],i),f.record&&f.record.addCls("app-building"),f._runDispatch(a,e).then(function(a){return a.on({scope:f,complete:function(a){f.record&&f.record.removeCls("app-building"),g(b)}}),d&&a.on({scope:f,logMessage:function(a){d(a)}}),a},h)},h)},h)})}},{key:"runDependencyBuild",value:function(a,b,c,d){b=this.getProfileName(b);var e,f=this,g=f.getBuildProfile(b),h=g.displayName,i=f.getName()+" Test Build "+h;return new _promise2["default"](function(g,h){f._extractDepBuildOptions(b,c).then(function(b){e=f._getDispatchConfig(["@"+b],i),f.record&&f.record.addCls("app-building"),f._runDispatch(a,e).then(function(a){return a.on({scope:f,complete:function(a){f.record&&f.record.removeCls("app-building"),g()}}),d&&a.on({scope:f,logMessage:function(a){d(a)}}),a},h)},h)})}},{key:"needsDevBuild",value:function(a){var b,c=this,d=c.getGeneratedSubjectUrl(c.getProfileName(a)),e=new File(c.workspace.dir),f=e.join(d);return b=!f.existsSync()&&[d]}}],[{key:"meta",get:function(){return{prototype:{isCodeBase:!0},mixins:[Testable,TargetUrl]}}}]),b}(WorkspaceMember);module.exports=CodeBase;