"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),child_process=require("child_process"),path=require("path"),scriptName="shell-wrapper.sh",xfs=require("../xfs"),tmpDir=xfs.tempDir,homeDir=xfs.homeDir,File=require("../fs/File"),dir=new File(__dirname),wrapperBase=path.join(__dirname,scriptName),wrapper=new File(dir,scriptName),platform={isLinux:/^linux/.test(process.platform),isMac:/^darwin/.test(process.platform),isWin:/^win/.test(process.platform)},fs=require("fs"),pidFormat=/^\d+$/,ProcessUtil=function(){function a(){(0,_classCallCheck3["default"])(this,a)}return(0,_createClass3["default"])(a,[{key:"_getCfg",value:function(a,b,c){return platform.isWin?this._getWinCfg(a,b,c):this._getUnixCfg(a,b,c)}},{key:"_getWinCfg",value:function(a,b,c){b=b||[],b.unshift("/C",a),a="cmd.exe";var d={encoding:"utf8"};return(0,_assign2["default"])(d,c),{executable:a,args:b,options:d}}},{key:"_getUnixCfg",value:function(a,b,c){b=b||[],b.unshift("-l",wrapper.getCanonicalPath(),a),a="/bin/bash";var d={encoding:"utf8"};return(0,_assign2["default"])(d,c),{executable:a,args:b,options:d}}},{key:"spawn",value:function(a,b,c){if("string"==typeof a&&(a=this._getCfg(a,b,c)),a.options&&a.options.cwd){var d=new File(a.options.cwd);d.ensurePathExistsSync()}return child_process.spawn(a.executable,a.args,a.options)}},{key:"spawnSync",value:function(a,b,c){if("string"==typeof a&&(a=this._getCfg(a,b,c)),a.options&&a.options.cwd){var d=new File(a.options.cwd);d.ensurePathExistsSync()}return child_process.spawnSync(a.executable,a.args,a.options)}},{key:"exec",value:function(a,b,c){if(b&&b.cwd){var d=new File(b.cwd);d.ensurePathExistsSync()}return child_process.exec(a,b,c)}},{key:"_winKill",value:function(a){var b=this.spawnSync({executable:"taskkill",args:["/PID",a,"/F","/T"],options:{encoding:"utf8"}});return b.error&&console.error(b.error.stack||b.error),0===b.status&&!b.error}},{key:"_unixKill",value:function(a){var b,c,d=this,e=child_process.spawnSync("pgrep",["-P",a],{encoding:"utf8"});return 0===e.status?(b=e.stdout.split("\n"),b.forEach(function(a){a=a&&a.trim(),a&&pidFormat.test(a)&&(c=parseInt(a),d._unixKill(c))})):e.error&&console.error(e.error.stack||e.error),e=child_process.spawnSync("kill",["-9",a],{encoding:"utf8"}),e.error&&console.error(e.error.stack||e.error),0===e.status&&!e.error}},{key:"kill",value:function(a){return platform.isWin?this._winKill(a):this._unixKill(a)}}]),a}();if(wrapper.path.indexOf("app.asar")>0&&(platform.isMac||platform.isLinux))try{var data=wrapper.readSync(),currentData;wrapper=homeDir.join("bin/sencha").join(scriptName),wrapper.getStat().then(function(a){var b,c,d=!0;a&&(currentData=wrapper.readSync(),b=a.birthtime.getTime(),c=a.mtime.getTime(),c-b>6e4?d=!1:data==currentData&&(d=!1)),d&&(a&&wrapper.removeSync(),wrapper.writeSync(data))})}catch(err){console.error(err.stack||err)}module.exports=new ProcessUtil;