"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),BasicRunner=require("./BasicRunner"),LocalBrowser=require("orion-core/lib/model/browser/Local"),Embedded=require("orion-core/lib/model/browser/Embedded"),Runner=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"startTestRun",value:function(a){a=a||{};var b,c,d,e,f,g,h,i,j,k=this,l=a.browsers,m=a.agentGroups||[],n=a.files,o=k.reporter,p=a.testIds,q=k.enableCodeCoverage;if(k.currentRunId&&(k._timeStamp=+new Date),k._passed=!0,k._messageQueue.length=0,k._runningAgents=0,k._queuedAgents=0,k.currentRunId++,k.enableCodeCoverage=!!a.enableCodeCoverage,k.testOptions=a.testOptions,j=k.enableCodeCoverage!=q,!n)throw new Error("No test files to run.");return k._runTestBuild().then(function(){k._setFiles(n),o.dispatch({type:"runStarted",files:n,testIds:p,browsers:l,agentGroups:m}),m&&(m=m.slice(),m.forEach(function(a){var b=a.browser;b&&!b.isLocalBrowser||k.launchLocalBrowser(b,a)})),l&&l.forEach(function(a){if(c=k.agentGroupsByBrowserId[a.id],a.isLocalBrowser&&!a.isEmbeddedBrowser)return c||(c=k.launchLocalBrowser(a)),void m.push(c);for(b=a.pool.farm,c||(c=k._getAgentGroup({id:k._generateAgentGroupId(),browser:a,browserPool:a.pool})),g=a.get("sencha").concurrency,h=a.get("chunks"),!g&&h&&console.log("Use of chunks is deprecated. Use sencha.concurrency instead."),g=Math.min(g||h,n.length),i=1;i<=g;i++)d=k._generateAgentId(),e=k._getAgent({id:d,farm:b,agentGroup:c,testIds:p,chunk:i,chunks:g,timeout:k.timeout,remoteTimeout:k.remoteTimeout,url:k.getAgentContactUrl({orionAgentId:d,orionChunk:i+"/"+g},!b)}),e.on("terminated",function(a){k.onRemoteAgentTerminated(a.agent)}),e.on("failed",function(a){var b=a.error,c=a.agent;c.farm,c.browser;o.dispatch({type:"agentFailed",error:b,willRetry:c.retries>0,agent:c}),c.retries--?k._launchAgent(c,j):(o.dispatch({type:"systemError",error:b,agent:c}),k.onRemoteAgentTerminated(a.agent))}),o.dispatch({type:"agentAdded",agent:e}),k._scheduleAgent(e,j)}),m&&m.forEach(function(a){f=a.agents;for(d in f)e=f[d],o.dispatch({type:"agentAdded",agent:e}),e.startTestRun(k.currentRunId,p,j)})},function(a){console.error(a.stack||a),k.stopTestRun()})}},{key:"onRemoteAgentTerminated",value:function(a){var b=this,c=a.farm;b._runningAgents--,c&&(c.sessionCount--,c.agentQueue.length&&(b._queuedAgents--,b._scheduleAgent(c.agentQueue.shift()))),b._runningAgents||b._queuedAgents||b.fire({type:"terminated",passed:b._passed})}},{key:"fail",value:function(){this._passed=!1}},{key:"stopTestRun",value:function(){this._messageQueue.length=0,this.cleanupAgents()}},{key:"_scheduleAgent",value:function(a,b){var c=this,d=a.farm;if(d){var e=Math.max(d.sessionLimit||0,1);d.sessionCount<e?(c._runningAgents++,d.sessionCount++,d.start().then(function(){c._launchAgent(a)})):(c._queuedAgents++,d.agentQueue.push(a))}else a.startTestRun(c.currentRunId,null,b),c._runningAgents++}},{key:"_launchAgent",value:function(a,b){var c=this;c.reporter.dispatch({type:"agentLaunched",agent:a}),a.launch().then(function(){c.fire({type:"agentLaunched",agent:a}),a.startTestRun(c.currentRunId,null,b)})}},{key:"_runTestBuild",value:function(){var a=this,b=a.scenario,c=b.project,d=b.get("profile"),e=c.owner,f=!1;return new _promise2["default"](function(c,g){if(e&&(e.isApp?b.get("launch")||(f=!0):f=!0,f=f&&e.needsDevBuild&&e.needsDevBuild(d)),f){var h=a.cmdClient;h?(e.appWatchInProcess=!0,e.runTestBuild(h,d,!1,function(a){var b=a.message.message;console.log(b)}).then(c,g)):g("Test Build needed, but Cmd installation not detected")}else c(a)})}}]),b}(BasicRunner);module.exports=Runner;