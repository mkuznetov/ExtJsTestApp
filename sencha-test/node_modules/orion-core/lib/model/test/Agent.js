"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),util=require("util"),Observable=require("orion-core/lib/Observable"),Agent=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this;a.isAgent=!0,a.timeout||(a.timeout=25e3),a.isRunning=!1,a.sequence=0,a._messages=[],a._callBacks={},a._messageSeq=0,a.lastConnectionOpenTime=0,a.lastConnectionCloseTime=0}},{key:"getMessages",value:function(){var a=this;return new _promise2["default"](function(b,c){var d=a._messages,e=function(c){a.onConnectionClose(),c&&(a._messages=[],b(d))};d.length?e(!0):(a._messageHandler=function(b){a._messageHandler=null,clearTimeout(a._flushTimeoutId),a._flushTimeoutId=null,e(b!==!1)},a._flushTimeoutId=setTimeout(a._messageHandler,a.timeout))})}},{key:"beforeRegister",value:function(){this._connectionCloseTimeout&&(clearTimeout(this._connectionCloseTimeout),this.fire("lostconnection"))}},{key:"onRegister",value:function(){return _promise2["default"].resolve()}},{key:"onConnectionOpen",value:function(a){var b=this;b.lastConnectionOpenTime=+new Date,clearTimeout(b._connectionCloseTimeout),a.once("close",function(){b._messageHandler&&b._messageHandler(!1),b.onConnectionClose(),b._connectionCloseTimeout=setTimeout(function(){b._lostConnection||b.terminated||(b.fire("lostconnection"),b._lostConnection=!0)},1e3)})}},{key:"onConnectionClose",value:function(){this.lastConnectionCloseTime=+new Date}},{key:"startTestRun",value:function(a,b,c){var d=this,e=b||d.testIds,f={type:"startTestRun",runId:a,reload:!!c,isRecording:!!d.isRecording},g=d.runner,h=g.getTestOptions();d.isRunning=!0,e&&(f.testIds=e),(0,_assign2["default"])(h,d.getTestOptions()),f.testOptions=h,d.sendMessage(f,!0)}},{key:"getTestOptions",value:function(){return{contextType:this.contextType}}},{key:"sendMessage",value:function(a,b,c){b&&"function"==typeof b&&(c=b,b=null),c=c||a.callback,delete a.callback,a.seq=++this._messageSeq,b?this._messages.unshift(a):this._messages.push(a),c&&(this._callBacks[a.seq]=c,a.responseRequired=!0),this.flushMessages()}},{key:"flushMessages",value:function(){this._messageHandler&&this._messageHandler()}},{key:"validateSequence",value:function(a){if(a!=++this.sequence){var b=util.format("Unexpected message sequence %d (expected: %d)",a,this.sequence);throw new Error(b)}}},{key:"reload",value:function(){this.sendMessage({type:"reload"})}},{key:"redirectTo",value:function(a){this.sendMessage({type:"redirect",url:a.url,port:a.port,page:a.page})}},{key:"isSupportedMessage",value:function(a){return this.supportedMessages[a]}},{key:"dispatch",value:function(a){var b,c,d=this,e=a.type;try{d.isSupportedMessage(e)&&d[e]&&(b=d[e](a))}catch(f){b=(f.stack||f).toString(),c=!0}return a.responseRequired?new _promise2["default"](function(d,e){b&&"function"==typeof b.then?b.then(function(b){d({type:"response",responseSeq:a.seq,value:b})})["catch"](function(b){d({type:"response",responseSeq:a.seq,error:b.message})}):d({type:"response",responseSeq:a.seq,value:c?null:b,error:c?b:null})}):void(c&&console.error(b))}},{key:"response",value:function(a){var b=this,c=a.responseSeq;if(b._callBacks[c])try{b._callBacks[c](a.value,a.error)}finally{delete b._callBacks[c]}}},{key:"testFinished",value:function(a){a.passed||this.runner.fail()}},{key:"testRunFinished",value:function(a){var b=this;b.isRunning=!1,b.fire("testrunfinished"),b.terminateOnFinish&&b.terminate()}},{key:"terminate",value:function(){var a=this,b=a.browser;b&&b.terminate&&b.terminate(),a.fire({type:"terminated",agent:a})}},{key:"setViewportSize",value:function(a){}},{key:"screenshot",value:function(a){var b=this;if(b.archiver&&b.archiver.enableScreenshots)return b._screenshot().then(function(c){if(c){var d=c.replace(/^data:image\/png;base64,/,""),e=new Buffer(d,"base64");return b.archiver.saveScreenshot(a.name,e,b)}})}},{key:"_screenshot",value:function(){var a=this.browser;return a&&a.screenshot?a.screenshot():_promise2["default"].resolve()}},{key:"log",value:function(a){console.log(a.message)}},{key:"browserFullName",get:function(){return this.browser.userAgent.name}},{key:"userAgentString",get:function(){return this.browser.userAgent.userAgent}}],[{key:"meta",get:function(){return{prototype:{contextType:"local"}}}}]),b}(Observable);Agent.prototype.supportedMessages={log:1,response:1,setViewportSize:1,screenshot:1,testFinished:1,testRunStarted:1,testRunFinished:1},module.exports=Agent;