"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),status=require("node-status"),consoleManager=require("orion-core/lib/util/console-manager"),Base=require("orion-core/lib/Base"),ReporterBase=require("orion-core/lib/reporter/ReporterBase"),spaces="  ",TextReporter=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(a){var b=this;b._breadcrumb={},b._browserLabel={},b._statusProgress=status.addItem("progress",{type:["bar","percentage"],color:"white",max:0}),b._statusTests=status.addItem("tests",{type:"count",color:"white",val:0}),b._statusPassed=status.addItem("passed",{type:"count",color:"green",val:0}),b._statusFailed=status.addItem("failed",{type:"count",color:"red",val:0}),status.start({label:"Sencha Test",invert:!1}),b._console=consoleManager.console=status.console()}},{key:"_getBreadcrumb",value:function(a){return this._breadcrumb[a]||(this._breadcrumb[a]=[])}},{key:"_printBreadcrumb",value:function(a){var b=this,c=b._getBreadcrumb(a),d=b._console,e="";d.log("");for(var f=0;f<c.length;f++){for(var g="",h=0;h<f;h++)g+=spaces;e=g+spaces,g+=c[f],d.log(g.bold)}return e}},{key:"agentAdded",value:function(a){var b=this,c=b._statusProgress;c.max++}},{key:"agentLaunched",value:function(a){var b=this,c=a.agent;b._newlineRequired&&b._console.log(""),b._console.log("[AGENT: %d] Launching agent".gray,c.id),b._newlineRequired=!1}},{key:"agentRegistered",value:function(a){var b=this,c=a.agent,d=b._browserLabel,e=c.agentGroup,f=e.id,g=d[f],h=c.driver?" (session ID: "+c.driver.requestHandler.sessionID+")":"";if(!g){var i=c.agentGroup.browser,j=i.canonicalName+(i.parsedVersion?i.parsedVersion.major:""),k=c.browserFullName;g=d[f]=j+" - "+k}b._newlineRequired&&b._console.log(""),b._console.log("[AGENT: %d] Agent registered%s: %s".gray,c.id,h,g),b._newlineRequired=!1}},{key:"agentTerminated",value:function(a){var b=this,c=a.agent;b._newlineRequired&&b._console.log(""),this._console.log("[AGENT: %d] Agent terminated".gray,c.id),b._newlineRequired=!1}},{key:"agentFailed",value:function(a){var b=this,c=a.agent,d=a.error,e=a.willRetry?" (will retry)":"";b._newlineRequired&&b._console.log(""),b._console.error("[AGENT: %d] Agent failed%s: %s".gray,c.id,e,d.stack||d),b._newlineRequired=!1}},{key:"testRunStarted",value:function(a){var b=this,c=a.agent,d=b._getBreadcrumb(c.id),e=b._browserLabel[c.agentGroup.id];d.push(e)}},{key:"testSuiteStarted",value:function(a,b){var b=a.agent,c=this._getBreadcrumb(b.id);c.push(a.name)}},{key:"testStarted",value:function(a){var b=a.agent,c=this._getBreadcrumb(b.id);c.push(a.name)}},{key:"testFinished",value:function(a){var b=this,c=a.agent,d=b._statusTests,e=b._statusPassed,f=b._statusFailed,g=b._console;if(d.inc(),a.passed)e.inc();else{var h=b._printBreadcrumb(c.id);f.inc(),a.expectations.forEach(function(a){if(!a.passed){var b=a.message;"object"===("undefined"==typeof b?"undefined":(0,_typeof3["default"])(b))&&(b=(0,_stringify2["default"])(b,null,4));var c=h+b;g.log(c.red)}}),b._newlineRequired=!0}var i=this._getBreadcrumb(c.id);i.pop()}},{key:"testSuiteFinished",value:function(a){var b=a.agent,c=this._getBreadcrumb(b.id);c.pop()}},{key:"testRunFinished",value:function(a){var b=this,c=a.agent,d=b._getBreadcrumb(c.id),e=b._statusProgress;d.pop(),e.inc()}},{key:"systemError",value:function(a){var b,c=this,d=a.agent,e=c._statusFailed;console.log("[AGENT: %d] System error:".red.bold,d.id),c._newlineRequired=!1,b=c._printBreadcrumb(d.id),console.log((b+a.message).red),a.error&&console.log((0,_stringify2["default"])(a.error,null,4).red),e.inc(),c._newlineRequired=!0}}]),b}(ReporterBase);module.exports=TextReporter;