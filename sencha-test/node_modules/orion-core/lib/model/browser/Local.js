"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),run=require("browser-launcher2/lib/run"),Instance=require("orion-core/lib/browser/Instance"),Observable=require("orion-core/lib/Observable"),Browser=require("./Browser"),Version=require("orion-core/lib/Version"),UserAgent=require("orion-core/lib/model/UserAgent"),Local=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){this.instances={},this.instCount=0}},{key:"launch",value:function(a){"string"==typeof a&&(a={url:a});var b=this;return new _promise2["default"](function(c,d){var e=b.data.name,f=b.data.version,g=b.data.profile,h=b.data.command,i=b.data.type,j=run({browsers:[{name:e,type:i,profile:g,command:h,version:f}]},e,f),k=[];"darwin"===process.platform&&(i.startsWith("chrome")?k.push(a.url):i.startsWith("opera")&&k.push("--disable-restore-session-state"));var l=Ext.apply({browser:e,version:f,command:h,detached:!0,options:k},a);Studio.log("browser.Local.launch() launchOpts="+(0,_stringify2["default"])(l)),j(a.url,l,function(a,e){if(a)Studio.log("browser.Local.launch, launcher err=",a),d(a);else{Studio.log("browser.Local.launch, launcher OK, instance=",e),e.process.unref(),e.process.stdin.unref(),e.process.stdout.unref(),e.process.stderr.unref();var f=new Instance(this,e),g=b.instCount=b.instCount+1;b.instances[g]=f,f.idx=g,f.on({scope:b,stop:function(){b.instances[f.idx]=null}}),c(f)}})})}},{key:"matchesUserAgent",value:function(a){var b=this.parsedVersion,c=a.browser,d=c.version,e=!0,f=UserAgent.local;return f&&(e=f.isOsEqual(a)),e&&c.name.toLowerCase()===this.data.name.toLowerCase()&&d.major===b.major&&(0===b.minor||d.minor===b.minor)}}],[{key:"meta",get:function(){return{prototype:{isLocalBrowser:!0}}}}]),b}(Browser);module.exports=Local;