"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Base=require("../Base"),ProcessUtil=require("../process/ProcessUtil"),Client=require("./Client"),Version=require("../Version"),Path=require("path"),xfs=require("../xfs"),File=require("../fs/File"),minimumCmdVer="6.0.0",Manager=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"forEachClient",value:function(a,b){var c,d=this.clients;for(c in d)if(!1===a.call(b,d[c]))break}},{key:"ctor",value:function(){var a=this;(0,_assign2["default"])(a,{versions:[],clients:{},current:null,latest:null,installDir:a.installDir||xfs.homeDir.join("bin/Sencha/Cmd").path});try{a._detectFileSystem()}catch(b){console.error(b.stack||b);try{a._detectPath()}catch(c){a.error=c||b}}}},{key:"_detectPath",value:function(){var a,b,c,d,e,f,g,h=this,i=!1,j=!1,k=!1;if(g=ProcessUtil.spawnSync("sencha",["switch","-list"],{encoding:"utf8"}),g.status||g.error){var l=g.error||g.stderr;throw console.error(l.stack||l),new Error(l)}for(e=g.stdout,d=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n"),c=d.split(/\n/g),a=0;a<c.length;a++)if(b=c[a],b=b&&b.trim())if(b.indexOf("Looking for versions at: ")>-1)h.basePath=b.substring(25);else if(b=b.toLowerCase(),b.indexOf("current version")>-1)i=!0;else if(b.indexOf("newest version installed")>-1)j=!0;else if(b.indexOf("locally available versions")>-1)k=!0;else if(/\d{1,4}\.\d{1,4}\.\d{1,4}\.\d{1,4}/.test(b)){f=b.trim();var m=new Version(f);m.gt(minimumCmdVer)&&(k?(h.versions.push(f),h.clients[f]=new Client({manager:h,version:new Version(f),directory:Path.join(h.basePath,f)})):j?h.latest=f:i&&(h.current=f))}h.latest=h.clients[h.latest],h.current=h.clients[h.current]||h.latest}},{key:"_detectFileSystem",value:function(){var a=this,b=new File(a.installDir);if(!b.existsSync())throw new Error("Sencha Cmd install directory not found : "+b);var c,d=b.getFilesSync(),e=/^\d{1,4}\.\d{1,4}\.\d{1,4}\.\d{1,4}$/;c=d.filter(function(a){return!a.isFile()&&e.test(a.name)}).map(function(a){return{file:a,ver:new Version(a.name)}}),c.sort(function(a,b){return Version.compare(a.ver,b.ver)}),d=c.map(function(a){return a.file}),d.forEach(function(b){var c=new Version(b.name),d=new Client({manager:a,version:c,directory:b.getCanonicalPath()});c.gt(minimumCmdVer)&&(a.versions.push(c.toString()),a.clients[c.toString()]=d,a.latest=d,a.current=d)});var f=b.join("version.properties");if(f.existsSync()){var g,h=f.readSync(),i="version.full=",j=h.indexOf(i);0===j&&(g=h.substring(i.length).trim(),a.clients[g]&&(a.current=a.clients[g]))}!a.current&&a.latest&&(a.current=a.latest)}}]),b}(Base);module.exports=Manager;