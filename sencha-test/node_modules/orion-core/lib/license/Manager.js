"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Base=require("orion-core/lib/Base"),Configuration=require("orion-core/lib/config/Configuration"),File=require("orion-core/lib/fs/File"),Json=require("orion-core/lib/Json"),Observable=require("orion-core/lib/Observable"),xfs=require("orion-core/lib/xfs"),License=require("orion-core/lib/license/License"),License0=require("orion-core/lib/license/License0"),NO_BUENO="License server request failed",Manager=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a,b,c,d,e,f,g=this,h=g.products,i=g.versionInfo;for(g._licenses=[],i.isConfiguration||(e=i.$isFile?i.path:i,g.versionInfo=i=new Configuration,i.loadSync(e)),g.appName=g.appName||i.get("app.name"),g.appShortName=g.appShortName||i.get("app.shortName"),g.appVer=g.appVer||i.get("app.version"),g.appMajorVer=g.appMajorVer||parseInt(g.appVer,10),c=i.get("app.expires"),c&&g.timeBomb!==!1&&(isNaN(+c)?c=new Date(c):(c=+c,a=i.get("app.build.date"),a=new Date(a),a.setTime(a.getTime()+24*c*60*60*1e3),c=a),g.timeBomb=c,c.setTime(6e4*c.getTimezoneOffset()+c.getTime())),g.licensePath||(g.licensePath=g.licenseDir.join(g.appShortName).join(g.appMajorVer+"").join(g.licenseFile).path),d=h.length;d-- >0;)b=h[d],e=b.name||g.appName,f=b.version||g.appVer,h[d]=(0,_assign2["default"])({name:e,version:1,fullVersion:f,productVersion:parseInt(f,10),"short":e.startsWith("Sencha ")?e.substring(7):e},b);g.load()}},{key:"log",value:function(a,b){void 0!==b?console.log(a,b):console.log(a)}},{key:"add",value:function(a,b){var c,d=this,e=a;if(!a.isLicense){if(!(c=d.getProduct(a)))return null;e=(0,_assign2["default"])({},a),e.product=c;var f=d.recognize(e);if(!f)return d.log("Ignoring unrecognized license",a),null;e=new f(e)}if(d.get(e.id))throw new Error("Cannot add license (duplicate id - "+e.id+")");return e.manager=d,d._licenses.push(e),b!==!1&&d.save(),d.fire("add",{license:e,save:b}),e}},{key:"each",value:function(a,b){var c,d=this.licenses,e=0,f=!0,g=!1,h=void 0;try{for(var i,j=(0,_getIterator3["default"])(d);!(f=(i=j.next()).done)&&(c=i.value,!1!==a.call(b,c,e++));f=!0);}catch(k){g=!0,h=k}finally{try{!f&&j["return"]&&j["return"]()}finally{if(g)throw h}}}},{key:"get",value:function(a){return this._licenses.find(function(b){return b.id===a})||null}},{key:"getProduct",value:function(a){var b,c,d=null;return a&&(c=a.product||a.Product,c&&(a=c),"string"==typeof a?a.startsWith("Sencha Test 1.x ")&&(a="test"):(b=a,a=a.code),d=this.products.find(function(b){return b.code===a})||null,d?d=(0,_assign2["default"])({},d,b):this.log('Unrecognized product code "'+a+'"')),d}},{key:"getProductLicenses",value:function(a){var b=this.getProduct(a);return b?this._licenses.filter(function(a){return a.product.code===b.code&&a.product.version===b.version}):[]}},{key:"setProxySettings",value:function(a){this.proxySettings=a}},{key:"load",value:function(){var a=this,b=a.timeBomb,c=a.read();b?(b=b.toISOString(),a.products.forEach(function(c){(a.development||"internal"!==c.code)&&a.add(new License({email:"tester@beta.sencha.com",expiration:b,product:a.getProduct(c)}),!1)}),a.development||c.forEach(function(b){b.product&&"internal"===b.product.code&&a.add(b,!1)})):c.forEach(function(b){return a.add(b,!1)})}},{key:"onActivate",value:function(a){this.save(),this.fire("activate",{license:a})}},{key:"read",value:function(){var a,b=this,c=new File(b.licensePath);if(c.existsSync()){if(a=c.readSync(),a=JSON.parse(a),Array.isArray(a))return a;if(a.License&&a.License.Signature)return[a.License];if(a.email?a.signature:a.Signature)return[a];b.log("License file must be an array of license objects")}else b.log("License file not found ("+b.licensePath+")");return[]}},{key:"recognize",value:function(a){return this.schemas.find(function(b){return b.grok(a)})}},{key:"remove",value:function(a,b){var c,d,e=this,f=e._licenses,g=null;return a&&(d=a.isLicense?a:e.get(a),d&&(c=f.indexOf(d),c<f.length&&(f.splice(c,1),b!==!1&&e.save(),e.fire("remove",{license:g=d,save:b})))),g}},{key:"save",value:function(){var a,b,c,d=this;return a=d.serialize(),c=d.read(),c=d.timeBomb?c.filter(function(a){return!(a.product&&"internal"===a.product.code)}):c.filter(function(a){return!d.recognize(a)||!d.getProduct(a)}),a.push.apply(a,c),a=(0,_stringify2["default"])(a,null,4),b=new File(d.licensePath),b.writeSync(a),this}},{key:"serialize",value:function(){var a=this._licenses.filter(function(a){return a.signature});return a=a.map(function(a){return a.serialize()})}},{key:"verify",value:function(){var a=[],b=[];return this.installedLicenses.forEach(function(c,d){a.push(c.verify().then(function(a){return b[d]=c}))}),_promise2["default"].all(a).then(function(a){return b})}},{key:"request",value:function(a){var b=this;return new _promise2["default"](function(c,d){var e,f=b.licenseServer,g=(0,_stringify2["default"])(a),h=b.requestor||require("https").request;e=h({method:"POST",hostname:f.url,path:f.path+(a.activationCode?"activate":"start"),headers:{"Content-Length":g.length,"Content-Type":"application/json"}},function(a){var e="";a.setEncoding("utf-8"),a.on("data",function(a){e+=a}),a.on("end",function(){if(b.log("Response received from license server. "+a.statusCode),b.log(e),200===a.statusCode)try{if(e=Json.parse(e),e.success)c(e);else{var f=new Error(NO_BUENO+": "+e.msg);f.response=e,f.errorCode=e.error||e.code,d(f)}}catch(g){g.message=NO_BUENO+": "+g.message,g.response=e,g.errorCode="bad-response",d(g)}else{var h=new Error(NO_BUENO+": error "+a.statusCode);h.errorCode="http-failure",h.statusCode=a.statusCode;try{h.response=Json.parse(e)}catch(g){h.response=e}d(h)}})}),e.on("error",function(a){var b=a instanceof Error?a:new Error(a);b.message=NO_BUENO+": "+b.message,b.errorCode="network-failure",d(b)}),b.log("Sending request for license..."),e.write(g),e.end()})}},{key:"count",get:function(){return this._licenses.length}},{key:"expired",get:function(){var a=this.timeBomb,b=Date.now();return!!a&&b>+a}},{key:"licenses",get:function(){return this._licenses.slice()}},{key:"installedLicenses",get:function(){var a=this;return this._licenses.filter(function(b){return b.signature||a.timeBomb})}}],[{key:"meta",get:function(){return{mixins:[Observable],prototype:{licenseDir:xfs.profileDir,licenseFile:"license.json",licenseServer:{path:"/v1.0/license/trial/",url:"api.sencha.com"},proxySettings:null,products:[],schemas:[License0,License],timeBomb:null}}}}]),b}(Base);module.exports=Manager;