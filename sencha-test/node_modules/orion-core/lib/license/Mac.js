"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Exec=require("child_process").exec,Crypto=require("crypto"),OS=require("os"),Base=require("../Base"),NO_BUENO="Could not determine MAC address",macRe=/(?:[a-z0-9]{2}[:\-]){5}[a-z0-9]{2}/gi,zeroRe=/(?:[0]{2}[:\-]){5}[0]{2}/,COMMAND=0===OS.platform().indexOf("win")?"getmac":"ifconfig || ip link",dashRe=/-/g,splitRe=/[,|]/,Mac=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"get",value:function(){var a=this,c=Date.now(),d=c<a._expire?a.executor:null;return d||(a._expire=c+a.ttl,a.executor=d=new _promise2["default"](function(a,c){Exec(COMMAND,function(d,e){var f;if(d){var g="string"==typeof d?new Error(d):d;g.message=NO_BUENO+": "+g.message,c(g)}else(f=b.parse(e))?a(f):c(new Error(NO_BUENO))})})),d}},{key:"getFingerprint",value:function(){return this.getHashes("|")}},{key:"getHashes",value:function(a){return this.get().then(function(c){return b.hashify(c,a)})}},{key:"verify",value:function(a){return this.getHashes().then(function(c){return!!b.intersect(a,c)})}}],[{key:"hashify",value:function(a,b){var c=a.map(function(a){return Crypto.createHash("sha1").update(a).digest("base64")});return b&&(c=c.join(b)),c}},{key:"intersect",value:function(a,b){var c="string"==typeof a?a.split(splitRe):a,d="string"==typeof b?b.split(splitRe):b,e=c.filter(function(a){return d.indexOf(a)>-1});return e.join("|")}},{key:"parse",value:function(a){for(var b,c,d=[];c=macRe.exec(a);)b=c[0],zeroRe.test(b)||(b=b.trim(),b=b.toUpperCase(),b=b.replace(dashRe,":"),d.push(b));return d.length?d:null}},{key:"meta",get:function(){return{prototype:{_expire:0,executor:null,ttl:3e5}}}}]),b}(Base);module.exports=Mac;