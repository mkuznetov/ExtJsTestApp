"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),CodeBase=require("./CodeBase"),fs=require("fs"),Path=require("path"),xfs=require("orion-core/lib/xfs"),File=require("orion-core/lib/fs/File"),Strings=require("orion-core/lib/Strings"),Package=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"loadChildren",value:function(){var a=this;return(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"loadChildren",this).call(this).then(function(){var c,d=a.get("subpkgs"),e=a.configFile;return d="string"==typeof d?d.split(","):d,e&&(d||(d=e.get("package.subpkgs"),d=d&&d.split(",")),d&&(c=e.get("package.subpkgs.dir")||"",d=d.map(function(a){return Path.join(c,a)}))),d&&d.length?b.loadAll(d,a).then(function(b){return a.packages=b,b&&a.workspace&&b.forEach(function(b){return b.setWorkspace(a.workspace)}),a},function(a){}):a})}},{key:"resolveVariables",value:function(a){return(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"resolveVariables",this).call(this,a).split("${package.dir}").join(this.dir)}},{key:"setSourceFile",value:function(a){(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"setSourceFile",this).call(this,a),this.data.dependencies&&(this.error=new Error("Node modules are not Sencha Cmd packages: "+a))}},{key:"getTargetUrl",value:function(a){var c=(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"getTargetUrl",this).call(this);return c||(c=this.getGeneratedSubjectUrl(a)),c}},{key:"getTargetPath",value:function(){return""}}],[{key:"grok",value:function(a){var b,c=this;return a=File.get(a),a.path.endsWith(c.jsonName)?a.getStat().then(function(b){return a.stat=b,a}):(b=a.join(c.jsonName),new _promise2["default"](function(d){b.getStat().then(function(e){e===!1?a.getFiles().then(function(a){var b=[],e=[];a.forEach(function(a){a.stat.isDirectory()&&(b.push(a=a.join(c.jsonName)),e.push(a.getStat().then(function(c){if(c===!1){var d=b.indexOf(a);b.splice(d,1)}else a.stat=c})))}),_promise2["default"].all(e).then(function(){d(b)})},function(a){d(null)}):e.isFile()?(b.stat=e,d(b)):d(new Error("Not a valid package location "+a))})}))}},{key:"loadAll",value:function(a,c){var d=this,e=a,f=[],g=function(a,c){var e=new b;return a.endsWith(d.jsonName)||(a=xfs.join(d.jsonName)),e.setSourceFile(a),e.error=c,f.push(e),e};return"string"==typeof a&&(e=a.split(",")),new _promise2["default"](function(a){var h=[];e.forEach(function(a){c&&(a=c.resolve(a)),h.push(d.grok(a).then(function(d){if(d instanceof Error)return g(a,d);if(d&&d.$isFile){var e=f.length;return f.push(d),b.load(d.path,c).then(function(a){f[e]=a})}if(d&&d.length){var h=[];return d.forEach(function(a){var d=f.length;f.push(a),h.push(b.load(a.path,c).then(function(a){f[d]=a}))}),_promise2["default"].all(h)}}))}),_promise2["default"].all(h).then(function(){f.sort(function(a,b){var c=a.getName(),d=b.getName();return Strings.compareNoCase(c,d)}),a(f)})})}},{key:"meta",get:function(){return{prototype:{isPackage:!0}}}},{key:"configPath",get:function(){return".sencha/package/sencha.cfg"}},{key:"jsonName",get:function(){return"package.json"}},{key:"kind",get:function(){return"Package"}}]),b}(CodeBase);module.exports=Package;