"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),co=require("co"),util=require("util"),Agent=require("./Agent"),RemoteAgent=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this;a.retries=a.retries||2,a.connRetryInterval=a.connRetryInterval||2e3,a.keepAliveInterval=a.keepAliveInterval||3e4,a.connectionTimeout=a.connectionTimeout||a.remoteTimeout||3e5,a.registrationTimeout=a.registrationTimeout||a.remoteTimeout||12e4,a.idleTimeout=a.idleTimeout||a.remoteTimeout||12e4}},{key:"_getBrowser",value:function(){var a=this;return a.browser||a.agentGroup.browser}},{key:"loadDriver",value:function(){var a,b=this,c=b.farm,d=b.agentGroup.browser.data;return a=b.driver=c.remoteDriver(d)}},{key:"setViewportSize",value:function(a){return this.driver.setViewportSize({width:a.width,height:a.height})}},{key:"screenshot",value:function(a){var b=this;if(b.archiver&&b.archiver.enableScreenshots)return b.driver.saveScreenshot().then(function(c){return b.archiver.saveScreenshot(a.name,c,b)})}},{key:"waitForDriverSessionID",value:function(){var a=this,b=(new Date).getTime(),c=12e4;return new _promise2["default"](function(d,e){var f=function g(){var f=a.driver.requestHandler.sessionID;(new Date).getTime();f?(a.seleniumSessionID=f,d(f)):(new Date).getTime()-b>c?e(util.format("[AGENT: %d] Couldn't get Selenium sessionID after 120 seconds",a.id)):setTimeout(g,1e3)};f()})}},{key:"testRunStarted",value:function(a){this.retries=0}},{key:"retry",value:function(a,b,c){return co(_regenerator2["default"].mark(function d(){return _regenerator2["default"].wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(!b--){d.next=15;break}return d.prev=1,d.next=4,a();case 4:return d.abrupt("break",15);case 7:if(d.prev=7,d.t0=d["catch"](1),b){d.next=11;break}throw d.t0;case 11:return d.next=13,function(a){setTimeout(a,c)};case 13:d.next=0;break;case 15:case"end":return d.stop()}},d,this,[[1,7]])}))}},{key:"dispatch",value:function(a){if(this._messageReceived(),!this._failed)return(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"dispatch",this).call(this,a)}},{key:"launch",value:function(){var a=this,b=a.loadDriver();return a._failed=!1,a._watchdogId=setInterval(a._watchdog.bind(a),a.watchdogInterval),co(_regenerator2["default"].mark(function c(){return _regenerator2["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.prev=0,a._connectionStart=(new Date).getTime(),c.next=4,b.init();case 4:return c.next=6,b.timeouts("script",1e4);case 6:if(a._connectionStart=null,a._failed){c.next=11;break}return a._registrationStart=(new Date).getTime(),c.next=11,b.url(a.url);case 11:c.next=16;break;case 13:c.prev=13,c.t0=c["catch"](0),a.fail(c.t0);case 16:case"end":return c.stop()}},c,this,[[0,13]])}))}},{key:"onRegister",value:function(){var a=this;return a._registrationStart=null,a._messageReceived(),a.waitForDriverSessionID().then(function(){a._keepAliveId=setInterval(a._keepAlive.bind(a),a.keepAliveInterval)})}},{key:"terminate",value:function(){var a=this;return a.sendMessage({type:"terminated"}),a._shutdown().then(function(){a.terminated=!0,a.fire({type:"terminated",agent:a})})}},{key:"fail",value:function(a){var b=this;return b._failed=!0,b._shutdown().then(function(){console.error(a.stack||a),b.fire({type:"failed",agent:b,error:a.stack||a})})}},{key:"_shutdown",value:function(){var a=this,b=a.driver;return co(_regenerator2["default"].mark(function c(){return _regenerator2["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(c.prev=0,null!=a._keepAliveId&&clearInterval(a._keepAliveId),null!=a._watchdogId&&clearInterval(a._watchdogId),a.sessionId=null,a.seleniumSessionID=null,a._connectionStart=null,a._registrationStart=null,a._lastMessage=null,!b){c.next=11;break}return c.next=11,b.end();case 11:c.next=17;break;case 13:c.prev=13,c.t0=c["catch"](0),console.error("Error shutting down remote agent"),console.error(c.t0.stack||c.t0);case 17:case"end":return c.stop()}},c,this,[[0,13]])}))}},{key:"_keepAlive",value:function(){this.driver.execute(function(){})}},{key:"_watchdog",value:function(){var a=this,b=a.seleniumSessionID,c=(new Date).getTime(),d=a._lastMessage,e=a._connectionStart,f=a._registrationStart,g=a.connectionTimeout,h=a.registrationTimeout,i=a.idleTimeout;d&&c-d>i?a.fail(util.format("No communication from remote browser received for %d ms (sessionID: %s)",i,b)):f&&c-f>h?a.fail(util.format("Agent didn't register within %d ms (sessionID: %s)",h,b)):e&&c-e>g&&a.fail(util.format("Couldn't allocate browser within %d ms",g))}},{key:"_messageReceived",value:function(){this._lastMessage=(new Date).getTime()}},{key:"browserFullName",get:function(){var a=this._getBrowser(),b=a.userAgent;return b?b.name:a.displayLabel}},{key:"userAgentString",get:function(){var a=this._getBrowser(),b=a.userAgent;return b&&b.userAgent}}],[{key:"meta",get:function(){return{prototype:{isRemoteAgent:!0,terminateOnFinish:!0}}}}]),b}(Agent);module.exports=RemoteAgent;