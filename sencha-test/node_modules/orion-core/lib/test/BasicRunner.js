"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),console=require("orion-core/lib/util/console-manager").console,Agent=require("../model/test/Agent.js"),AgentGroup=require("../model/test/AgentGroup.js"),Browser=require("orion-core/lib/model/browser/Browser"),CodeInstrumenter=require("./CodeInstrumenter"),Html=require("orion-core/lib/Html"),LocalBrowser=require("orion-core/lib/model/browser/Local"),LocalBrowserPool=require("orion-core/lib/browser/LocalPool"),MessageValidator=require("./MessageValidator"),Observable=require("../Observable"),RemoteAgent=require("../model/test/RemoteAgent.js"),ProxyServer=require("orion-core/lib/web/ProxyServer"),UserAgent=require("../model/UserAgent.js"),Util=require("orion-core/lib/Util"),Url=require("url"),urlParse=Url.parse,BasicRunner=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a,c,d=this;d.id=++b._idSeed,d._timeStamp=+new Date,d._agentIdSeed=0,d._agentGroupIdSeed=0,d.agents={},d.agentGroups={},d.agentGroupsByBrowserId={},d.agentGroupsByUserAgent={},d._sessionCount={},d._validator=new MessageValidator,d.currentRunId=0,d.messageChunkSize=d.messageChunkSize||0,d._messageQueue=[],d.scenario=d.scenario.descriptor||d.scenario,d.project=d.scenario.project,d.enableCodeCoverage=d.enableCodeCoverage||!1,d.callbackAddress=d.callbackAddress||Util.getLocalIpAddress(),d._setFiles(d.files||[]),d.reporter=d.wrapReporters(d.reporter),a=d.proxy&&!d.proxy.stopped||(d.proxy=new ProxyServer({port:d.port,portSeed:d.portSeed,noProxy:d.noProxy,scenario:d.scenario})),c=a.getRootResponder(),c.clearInterceptors();var e=d.getInterceptablePage();e.endsWith("index.html")&&(e=e.replace(/\/index\.html$/g,"/(index.html)?")),c.intercept("[/]?"+e+"[/]?$",d._interceptSubjectPage.bind(d)),c.intercept(".*?\\.js$",d._interceptJsFile.bind(d)),c.register({"~orion":{routes:{register:{get:function(a){return d._onAgentRegister({request:a.request,response:a.response,agentId:parseInt(a.url.query.agentId,10),proxyId:a.url.query.proxyId,sessionId:a.url.query.sessionId,runnerId:a.url.query.runnerId,url:a.url,content:a.content,address:this.getRequestAddress(a.request),isLocal:this.isLocalRequest(a.request)})}},messages:{get:function(a){return d._onAgentMessages({request:a.request,response:a.response,agentId:parseInt(a.url.query.agentId,10),proxyId:a.url.query.proxyId,runId:parseInt(a.url.query.runId,10),url:a.url,content:a.content})}},updates:{get:function(a){return d._onAgentUpdates({response:a.response,agentId:parseInt(a.url.query.agentId,10),proxyId:a.url.query.proxyId,runId:parseInt(a.url.query.runId,10),url:a.url,content:a.content})}}}}}),d.instrumenter=new CodeInstrumenter({scenario:d.scenario})}},{key:"cachify",value:function(a){var b=this.cacheBuster;return a&&b&&(a+=a.indexOf("?")<0?"?":"&",a+="_dc=",a+=b===!0?this._timeStamp:b),a}},{key:"setDefaultProxyUrl",value:function(a){this.defaultProxyUrl=this.proxy.getRootResponder().defaultProxyUrl=a}},{key:"_getLibsContent",value:function(){var a=this,b="",c=[],d=a.testFrameworkFiles[a.scenario.getTestFramework()];return a.orionCoreCssFiles.forEach(function(c){b+='<link rel="stylesheet" type="text/css" href="'+a.cachify(c)+'"/>\n'}),b+="<script>ST.runnerId="+a.id+";</script>\n",c.push.apply(c,a.orionCoreFiles),d&&c.push.apply(c,d),c.push.apply(c,a.scenario.getLibs("/~orion/workspace")),c.filter(function(a){return!!a}).forEach(function(c){b+='<script src="'+a.cachify(c)+'"></script>\n'}),b}},{key:"parseInstrument",value:function(a,b,c){var d,e,f,g,h,i=Html.parse(a);if(i&&(i.forEach(function(a){h||"tag"!==a.type||"html"!==a.name||(h=a,h.children&&h.children.forEach(function(a){f||"tag"!==a.type||"head"!==a.name||(f=a)}),f||Html.appendChild(h,f={type:"tag",name:"head"}))}),f)){f.children||(f.children=[]);var j=f.children[0];f.children.forEach(function(a){"tag"===a.type&&"base"===a.name&&(j=a.next)}),d=Html.parse(c),e=Html.parse(b),Html.insertBefore(f,e,j),Html.appendChild(f,d),g=Html.stringify(i)}return g}},{key:"getInterceptablePage",value:function(){return this.scenario.getSubjectPage()}},{key:"_interceptSubjectPage",value:function(a,b){var c,d,e,f=this,g=b.responderContext,h=g.url.query.orionChunk,i=h&&h.split("/"),j=i&&i[0],k=i&&i[1],l=f._getLibsContent(),m="",n=f.project.getWorkspaceMountDir().replace(/\\/g,"/"),o=f.project.resolve(f.scenario.get("directory")).replace(/\\/g,"/");return l='\n<script src="'+f.cachify("/~orion/files/init.js")+'"></script>\n'+l,m+="\n<script>ST.beforeFiles();</script>\n",f._getChunkFiles(j,k).forEach(function(a){d=a.substring(n.length+1),e=a.substring(o.length+1),m+='<script>ST.beforeFile("'+e+'");</script>\n',m+='<script src="/~orion/workspace/'+f.parseFile(d,!0)+'"></script>\n',m+='<script>ST.afterFile("'+e+'");</script>\n'}),m+="<script>ST.afterFiles();</script>\n",(c=f.parseInstrument(a,l,m))||(c=a.replace(/<head>/,"<head>"+l),c=c.replace(/<\/head>/,m+"</head>")),c}},{key:"parseFile",value:function(a,b){return a=a.replace(/\\/g,"/").split("/").map(function(a){return a.split(".").map(function(a){return encodeURIComponent(a)}).join(".")}).join("/"),b?this.cachify(a):a}},{key:"_split",value:function(a,b){for(var c=a.length,d=[],e=0;e<c;){var f=Math.ceil((c-e)/b--);d.push(a.slice(e,e+=f))}return d}},{key:"_getChunkFiles",value:function(a,b){var c=this,d=c._getFiles();return a?(d=c._split(d,b),d[a-1]):d}},{key:"_interceptJsFile",value:function(a,b){var c=this,d=c.instrumenter,e=b.responderContext,f=e.url;return c.enableCodeCoverage?d.instrument(a,f.pathname):a}},{key:"start",value:function(){var a=this,b=a.agents,c=!1,d=!1;for(var e in b)e.isSandbox?d=!0:c=!0;c&&a.startProxy()}},{key:"startProxy",value:function(){this.proxy.start()}},{key:"getAgentContactUrl",value:function(a,b){var c=this,d=b?"127.0.0.1":c.callbackAddress;return"http://"+d+":"+c.proxy.port+"/"+c.getAgentContactPage(a)}},{key:"getAgentContactPage",value:function(a){return this.parameterizePage(this.scenario.getSubjectPath(),a)}},{key:"parameterizePage",value:function(a,b){var c=urlParse(a,!0),d="&";if(b)for(var e in b){var f=b[e];null!=f&&(d=0!==c.search.indexOf("?")?"?":"&",c.search+=d+e+"="+f)}return Url.format({pathname:c.pathname,search:c.search,hash:c.hash})}},{key:"launchLocalBrowser",value:function(a,b,c){var d,e,f,g,h,i,j,k,l,m=this,n=m.scenario,o=n.project,p=o.owner,q=1e3,r=a&&a.userAgent||b&&b.userAgent||c&&c.userAgent,s=r&&r.fullId;if(Studio.log(s+" BasicRunner.launchLocalBrowser()"),b&&(Studio.log(s+" BasicRunner.launchLocalBrowser, have AgentGroup so get first Agent"),h=b.firstAgent(),h&&(Studio.log(s+" BasicRunner.launchLocalBrowser, have Agent, use it"),d=h.lastConnectionCloseTime,e=h.lastConnectionOpenTime,d>e))){if(f=+new Date-d,!(f>q))return setTimeout(function(){m.launchLocalBrowser(a,b)},q-f),b;m.parkAgent(h),h=null}if(!h&&(Studio.log(s+" BasicRunner.launchLocalBrowser, no Agent"),c&&(i=c.userAgent,j=c.address,c.destroyed?b&&b.count()||a||(c=m.unparkAgent(i),c||(b=b||m._getAgentGroup({id:m._generateAgentGroupId(),browserPool:a?a.pool:i.local?LocalBrowserPool.instance:null,browser:a||null,address:j}),m._setAgentGroupUserAgent(b,i))):c=m.unparkAgent(i)),c||(Studio.log(s+" BasicRunner.launchLocalBrowser, no parkedAgent"),i=b&&b.userAgent||a.userAgent,j=b&&b.address||"localhost",j&&i&&(c=m.unparkAgent(i))),c||a))if(Studio.log(s+" BasicRunner.launchLocalBrowser, have parkedAgent or a browser"),g=m._generateAgentId(),b||(Studio.log(s+" BasicRunner.launchLocalBrowser, have parkedAgent or browser and no agentGroup"),a&&(b=m.agentGroupsByBrowserId[a.id]),b||(b=m._getAgentGroup({id:m._generateAgentGroupId(),browserPool:a?a.pool:c.userAgent.local?LocalBrowserPool.instance:null,browser:a||null}),c&&c.userAgent&&m._setAgentGroupUserAgent(b,i))),h=m._getAgent({id:g,terminateOnFinish:m.terminateAgents,browser:a}),b.add(h),c&&(b.address=h.address=c.address,b.userAgent=h.userAgent=c.userAgent),m._onAgentAdded(h),k={orionAgentId:g,orionRecording:m.isRecording},c)Studio.log(s+" BasicRunner.launchLocalBrowser, have parkedAgent, redirectTo contactPage: "+m.getAgentContactPage(k)),c.redirectTo({port:m.proxy.port,page:m.getAgentContactPage(k)});else if(a){l=m.getAgentContactUrl(k,a.isLocalBrowser),Studio.log(s+" BasicRunner.launchLocalBrowser, have browser, launch/open with url="+l);var t=n.get("profile"),u=!1;if(p&&(p.isApp?n.get("launch")||(u=!0):u=!0,u=u&&p.needsDevBuild&&p.needsDevBuild(t)),p&&p.isApp&&o.get("launchAppWatch")){p.getBuildProfile(t);p.launch(t).then(function(){a.launch({url:l})},function(a){console.error(a.stack||a)})}else u?p.runTestBuild(p.cmdClient,t,!1).then(function(){Studio.log(s+" BasicRunner.launchLocalBrowser, have browser, shouldRunTestBuild done, call browser.launch"),a.launch({url:l})}):(Studio.log(s+" BasicRunner.launchLocalBrowser, have browser, no app or testbuild, so call browser.launch"),a.launch({url:l}))}return Studio.log(s+" BasicRunner.launchLocalBrowser, returning agentGroup=",b),b}},{key:"cleanupAgents",value:function(){var a,b,c=this,d=c.agents;for(a in d)b=d[a],b.terminateOnFinish?b.terminate():b.isRemoteAgent||c.parkAgent(b)}},{key:"destroy",value:function(){this.destroyed=!0,this._messageQueue.length=0,this.cleanupAgents(),this.proxy.stop()}},{key:"_onAgentAdded",value:function(a){var b=this.reporter;b&&b.dispatch({type:"agentAdded",agent:a})}},{key:"_generateAgentId",value:function(){return++this._agentIdSeed}},{key:"_generateAgentGroupId",value:function(){return++this._agentGroupIdSeed}},{key:"_onAgentRegister",value:function(a){var b,c,d,e,f,g=this,h=a.request,i=a.address,j=a.isLocal,k=g.agents,l=(h.headers["user-agent"],UserAgent.fromRequest(h)),m=a.sessionId,n=a.agentId,o=a.runnerId,p=k[n],q=g.reporter;if(p&&p.beforeRegister(),o!=g.id)return[{type:"reload",forced:!0}];if(!a.sessionId)return[{type:"error",message:"test agent must supply sessionId during registration"}];if(!p||p.sessionId&&p.sessionId!==a.sessionId){if(c=!0,b=g.agentGroupsByUserAgent[l.groupId],b&&b.count()){e=b.agents;for(f in e)g.parkAgent(e[f])}n=g._generateAgentId(),p=g._getAgent({id:n}),j&&!b&&(d=LocalBrowserPool.instance.lookupBrowserByUserAgent(l),d&&(b=g.agentGroupsByBrowserId[d.id])),b||(b=g._getAgentGroup({id:g._generateAgentGroupId(),browserPool:j?LocalBrowserPool.instance:null,browser:d||null})),b.add(p)}else b=p.agentGroup;return p.userAgent=l,d=b.browser,d&&!p.isSandboxAgent&&(d.userAgent=l,!d.parsedVersion&&l.browser&&(d.parsedVersion=l.browser.version)),(c||d&&d.isLocalBrowser)&&(g._setAgentGroupUserAgent(b,l),b.address=p.address=i),c&&g._onAgentAdded(p),p.sequence=0,p.sessionId=m,p.onRegister().then(function(){q.dispatch({type:"agentRegistered",agent:p})},function(a){console.error(a.stack||a)}),[{type:"handshake",agentId:n,proxyId:g.proxy.id}]}},{key:"_onAgentMessages",value:function(a){var b,c=this,d=a.agentId,e=a.proxyId,f=a.response,g=c.agents[d];return g&&e==c.proxy.id?(b=c._onAgentUpdates(a),b&&"function"==typeof b.then&&b.then(function(a){a.forEach(function(a){g.sendMessage(a)})}),g.onConnectionOpen(f),g.getMessages()):c._redirectUnknownAgent()}},{key:"_onAgentUpdates",value:function(a){var b=this,c=a.agentId,d=b.agents[c],e=a.proxyId,f=a.content;return d&&e==b.proxy.id?void(!f||a.runId&&a.runId!==b.currentRunId||this._queueMessages(JSON.parse(f),d)):b._redirectUnknownAgent()}},{key:"_queueMessages",value:function(a,b){var c=this;return new _promise2["default"](function(d,e){var f,g,h=c.messageChunkSize,i=c._messageQueue,j=!i.length,k=a.length,l=[];if(l.push(d),h)for(f=0,g=Math.ceil(k/h);f<k;f+=h,g--)l[g]={agent:b,messages:a.slice(f,f+h)};else l[1]={agent:b,messages:a};i.unshift.apply(i,l),j&&c._scheduleMessageChunk()})}},{key:"_scheduleMessageChunk",value:function(){var a=this,b=a.deferFn;a._messageQueue.length&&(b?b(a._nextMessageChunk,a):a._nextMessageChunk())}},{key:"_nextMessageChunk",value:function(){var a,b,c=this,d=c._messageQueue;d.length&&(a=d.pop(),"function"==typeof a?(a(),c._scheduleMessageChunk()):(b=a.agent,b.removed||c._processMessages(a.messages,b).then(function(a){a.forEach(function(a){b.sendMessage(a)}),c._scheduleMessageChunk()})))}},{key:"_processMessages",value:function(a,b){var c,d,e=this,f=a.length,g=e._validator,h=[];for(c=0;c<f;c++)d=a[c],g.validate(d)?(e.reporter&&e.reporter.dispatch((0,_assign2["default"])({agent:b},d)),h.push(b.dispatch(d))):console.error("Invalid message received",d);return _promise2["default"].all(h.filter(function(a){return!!a}))}},{key:"_getFiles",value:function(){var a=this,b=a.files;return b&&0!==b.length||(b=a.scenario.getFiles()),b.map(function(a){return a.replace(/\\/g,"/")})}},{key:"_setFiles",value:function(a){this.files=a}},{key:"_getAgent",value:function(a){var b=this,c=a.id,d=b.agents,e=a.agentGroup,f=d[c];return f?(0,_assign2["default"])(f,a):d[c]=f=b._createAgent(a),f.on({lostconnection:"_onAgentLostConnection",terminated:"_onAgentTerminated",scope:b}),f.browser&&f.on({testrunfinished:"_onAgentTestRunFinished",scope:b}),e&&e.add(f),f.runner=b,f}},{key:"_createAgent",value:function(a){var b,c=this;return b=a.farm?new RemoteAgent((0,_assign2["default"])({archiver:c.archiver},a)):new Agent(a)}},{key:"_getAgentGroup",value:function(a){var b=a.id,c=this.agentGroups,d=c[b],e=a.userAgent,f=a.browser;return d?(0,_assign2["default"])(d,a):(d=c[b]=new AgentGroup(a),f&&(this.agentGroupsByBrowserId[f.id]=d),e&&this._setAgentGroupUserAgent(d,e)),d}},{key:"_setAgentGroupUserAgent",value:function(a,b){a.userAgent=b,this.agentGroupsByUserAgent[b.userAgent]=a}},{key:"_onAgentLostConnection",value:function(a){var b=this.reporter;b&&b.dispatch({type:"agentLostConnection",agent:a.sender})}},{key:"_onAgentTerminated",value:function(a){this.removeAgent(a.sender)}},{key:"_onAgentTestRunFinished",value:function(a){this.parkRunner&&this.parkAgent(a.sender)}},{key:"_redirectUnknownAgent",value:function(){var a=this,b=a.parkingLot;return b?[{type:"redirect",port:b.getPort()}]:[{type:"redirect",url:"about:blank"}]}},{key:"wrapReporters",value:function(a){var b=this;a=Array.isArray(a)?a.slice(0):[a];var c={add:function(b){a.indexOf(b)<0&&a.push(b)},dispatch:function(c){var d=c.type;b.destroyed||a.forEach(function(a){try{a.supportedMessages[d]&&a.dispatch(c)}catch(b){console.log(b)}})},remove:function(b){var c=a.indexOf(b);c>=0&&a.splice(c,1)}};return c}},{key:"removeAgent",value:function(a){function b(){g[f]&&(e&&e.dispatch({type:"agentTerminated",agent:a}),a.sendMessage({type:"terminated"}),d&&d.remove(a),delete g[f],a.removed=!0)}var c=this,d=a.agentGroup,e=c.reporter,f=a.id,g=c.agents,h=c._messageQueue;h.length?h.unshift(b):b()}},{key:"parkAgent",value:function(a){var b=this,c=b.parkingLot;c&&!a.isRemoteAgent?c.park(a):a.redirectTo("about:blank"),b.removeAgent(a)}},{key:"unparkAgent",value:function(a){return this.parkingLot.unpark(a)}},{key:"getTestOptions",value:function(){var a=this,b=a.scenario,c=b.project,d={};return(0,_assign2["default"])(d,c.data.options),(0,_assign2["default"])(d,b.data.options),(0,_assign2["default"])(d,a.testOptions),d}}],[{key:"meta",get:function(){return{prototype:{cacheBuster:!0,orionCoreFiles:["/~orion/files/setup-ext.js","/~orion/files/supports.js","/~orion/files/base.js","/~orion/files/common.js","/~orion/files/context/Base.js","/~orion/files/context/Local.js","/~orion/files/context/WebDriver.js","/~orion/files/context/WebDriverRecorder.js","/~orion/files/Version.js","/~orion/files/Browser.js","/~orion/files/OS.js","/~orion/files/Element.js","/~orion/files/Timer.js","/~orion/files/KeyMap.js","/~orion/files/Alert.js","/~orion/files/Url.js","/~orion/files/event/Event.js","/~orion/files/event/wgxpath.install.js","/~orion/files/Locator.js","/~orion/files/locator/Strategy.js","/~orion/files/event/Driver.js","/~orion/files/event/Event.js","/~orion/files/event/Injector.js","/~orion/files/playable/Playable.js","/~orion/files/playable/State.js","/~orion/files/event/Player.js","/~orion/files/event/Recorder.js","/~orion/files/event/MagicCanvasRecorder.js","/~orion/files/event/GestureQueue.js","/~orion/files/future/Element.js","/~orion/files/future/Component.js","/~orion/files/orion.js"],orionCoreCssFiles:["/~orion/files/base.css","/~orion/files/alert.css"],testFrameworkFiles:{jasmine:["/~orion/files/jasmine/jasmine.js","/~orion/files/jasmine-orion.js","/~orion/files/jasmine-pre-extensions.js","/~orion/files/jasmine/boot.js","/~orion/files/jasmine-post-extensions.js","/~orion/files/Expect.js"]}}}}}]),b}(Observable);BasicRunner._idSeed=0,BasicRunner.parkingLot={},module.exports=BasicRunner;