"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Observable=require("orion-core/lib/Observable"),File=require("orion-core/lib/fs/File"),Zip=require("orion-core/lib/fs/Zip"),Json=require("orion-core/lib/Json"),co=require("co"),mv=require("mv"),util=require("util"),xfs=require("orion-core/lib/xfs"),path=require("path"),Merger=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"merge",value:function(a,b){var c,d,e,f,g=this;return g.rootDir1=c=a.$isFile?a:new File(xfs.resolve(a)),g.rootDir2=d=b.$isFile?b:new File(xfs.resolve(b)),g.rootDataFile1=e=c.join("data.json"),g.rootDataFile2=f=d.join("data.json"),co(_regenerator2["default"].mark(function h(){var a,b,f,i;return _regenerator2["default"].wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return i=function j(c,d,e){var f,h,i,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V;return _regenerator2["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return f=c.join("data.json"),h=d.join("data.json"),a.next=3,Json.read(h.path);case 3:return k=a.sent,a.next=6,c.ensurePathExists();case 6:return a.next=8,f.exists();case 8:if(!a.sent){a.next=14;break}return a.next=11,Json.read(f.path);case 11:a.t0=a.sent,a.next=15;break;case 14:a.t0={type:k.type,name:k.name,dir:k.dir};case 15:i=a.t0,i.id=e,i.children=g._mergeChildren(i.children,k.children,b),l=!0,m=!1,n=void 0,a.prev=21,o=(0,_getIterator3["default"])(b);case 23:if(l=(p=o.next()).done){a.next=48;break}for(q=p.value,i[q]=0,r=!0,s=!1,t=void 0,a.prev=29,u=(0,_getIterator3["default"])(i.children);!(r=(v=u.next()).done);r=!0)w=v.value,w[q]===!1?i[q]++:"number"==typeof w[q]&&(i[q]=i[q]+w[q]);a.next=37;break;case 33:a.prev=33,a.t1=a["catch"](29),s=!0,t=a.t1;case 37:a.prev=37,a.prev=38,!r&&u["return"]&&u["return"]();case 40:if(a.prev=40,!s){a.next=43;break}throw t;case 43:return a.finish(40);case 44:return a.finish(37);case 45:l=!0,a.next=23;break;case 48:a.next=54;break;case 50:a.prev=50,a.t2=a["catch"](21),m=!0,n=a.t2;case 54:a.prev=54,a.prev=55,!l&&o["return"]&&o["return"]();case 57:if(a.prev=57,!m){a.next=60;break}throw n;case 60:return a.finish(57);case 61:return a.finish(54);case 62:return k.scenarios&&(i.scenarios?i.scenarios=g._mergeEntries(i.scenarios,k.scenarios,"path"):i.scenarios=k.scenarios),k.browsers&&(i.browsers?i.browsers=g._mergeEntries(i.browsers,k.browsers,"id"):i.browsers=k.browsers),a.next=66,d.getFiles();case 66:x=a.sent,y=!0,z=!1,A=void 0,a.prev=70,B=(0,_getIterator3["default"])(x);case 72:if(y=(C=B.next()).done){a.next=86;break}if(D=C.value,".png"!==path.extname(D.path).toLowerCase()){a.next=83;break}return E=path.basename(D.path),F=c.join(E),a.next=79,xfs.exists(F);case 79:if(G=a.sent,G&&!g.overwrite){a.next=83;break}return a.next=83,xfs.copy(D,F);case 83:y=!0,a.next=72;break;case 86:a.next=92;break;case 88:a.prev=88,a.t3=a["catch"](70),z=!0,A=a.t3;case 92:a.prev=92,a.prev=93,!y&&B["return"]&&B["return"]();case 95:if(a.prev=95,!z){a.next=98;break}throw A;case 98:return a.finish(95);case 99:return a.finish(92);case 100:if(!k.coverages){a.next=133;break}if(i.coverages){a.next=105;break}i.coverages=k.coverages,a.next=133;break;case 105:H=[],I=!0,J=!1,K=void 0,a.prev=109,L=(0,_getIterator3["default"])(k.coverages);case 111:if(I=(M=L.next()).done){a.next=118;break}return N=M.value,a.next=115,xfs.copy(d.join(N.path),c.join(N.path));case 115:I=!0,a.next=111;break;case 118:a.next=124;break;case 120:a.prev=120,a.t4=a["catch"](109),J=!0,K=a.t4;case 124:a.prev=124,a.prev=125,!I&&L["return"]&&L["return"]();case 127:if(a.prev=127,!J){a.next=130;break}throw K;case 130:return a.finish(127);case 131:return a.finish(124);case 132:i.coverages=g._mergeEntries(i.coverages,k.coverages,"path");case 133:return a.next=135,Json.write(f.path,i);case 135:O=!0,P=!1,Q=void 0,a.prev=138,R=(0,_getIterator3["default"])(i.children);case 140:if(O=(S=R.next()).done){a.next=152;break}if(T=S.value,!T.dir){a.next=149;break}return U=c.join(T.dir),V=d.join(T.dir),a.next=146,xfs.exists(V);case 146:if(!a.sent){a.next=149;break}return a.next=149,j(U,V,T.id);case 149:O=!0,a.next=140;break;case 152:a.next=158;break;case 154:a.prev=154,a.t5=a["catch"](138),P=!0,Q=a.t5;case 158:a.prev=158,a.prev=159,!O&&R["return"]&&R["return"]();case 161:if(a.prev=161,!P){a.next=164;break}throw Q;case 164:return a.finish(161);case 165:return a.finish(158);case 166:case"end":return a.stop()}},a[0],this,[[21,50,54,62],[29,33,37,45],[38,,40,44],[55,,57,61],[70,88,92,100],[93,,95,99],[109,120,124,132],[125,,127,131],[138,154,158,166],[159,,161,165]])},a=[i].map(_regenerator2["default"].mark),h.next=4,g._getNewBrowserIds();case 4:return b=h.sent,h.next=7,Json.read(e.path);case 7:return f=h.sent,g._maxId=f.maxId||0,h.next=12,i(c,d);case 12:return h.next=14,Json.read(e.path);case 14:return f=h.sent,f.maxId=g._maxId,h.next=18,Json.write(e.path,f);case 18:case"end":return h.stop()}},h,this)}))}},{key:"_mergeEntries",value:function(a,b,c){for(var d=this,e={},f=0;f<a.length;f++){var g=a[f];e[g[c]]=f}var h=!0,i=!1,j=void 0;try{for(var k,l=(0,_getIterator3["default"])(b);!(h=(k=l.next()).done);h=!0){var m=k.value;if(void 0===e[m[c]])a.push(m);else{var n=e[m[c]];void 0==n?a.push(m):d.overwrite&&(a[n]=m)}}}catch(o){i=!0,j=o}finally{try{!h&&l["return"]&&l["return"]()}finally{if(i)throw j}}return a}},{key:"_mergeChildren",value:function(a,b,c){var d=this,e={};a=a||[];var f=!0,g=!1,h=void 0;try{for(var i,j=(0,_getIterator3["default"])(a);!(f=(i=j.next()).done);f=!0){var k=i.value;e[k.name]=k}}catch(l){g=!0,h=l}finally{try{!f&&j["return"]&&j["return"]()}finally{if(g)throw h}}var m=!0,n=!1,o=void 0;try{for(var p,q=(0,_getIterator3["default"])(b);!(m=(p=q.next()).done);m=!0){var r=p.value,s=e[r.name];if(s){var t=!0,u=!1,v=void 0;try{for(var w,x=(0,_getIterator3["default"])(c);!(t=(w=x.next()).done);t=!0){var y=w.value;("undefined"==typeof s[y]||d.overwrite)&&(s[y]=r[y])}}catch(l){u=!0,v=l}finally{try{!t&&x["return"]&&x["return"]()}finally{if(u)throw v}}r.details&&(s.details=d._mergeEntries(s.details,r.details,"browser"))}else r.id=++d._maxId,a.push(r)}}catch(l){n=!0,o=l}finally{try{!m&&q["return"]&&q["return"]()}finally{if(n)throw o}}return a}},{key:"_getNewBrowserIds",value:function(){var a=this;return Json.read(a.rootDataFile2.path).then(function(a){var b=[],c=!0,d=!1,e=void 0;try{for(var f,g=(0,_getIterator3["default"])(a.browsers);!(c=(f=g.next()).done);c=!0){var h=f.value;b.push(h.id)}}catch(i){d=!0,e=i}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}return b})}},{key:"_areEqual",value:function(a,b){return a.canonicalName===b.canonicalName&&a.version===b.version&&a.canonicalPlatform===b.canonicalPlatform}}]),b}(Observable);module.exports=Merger;